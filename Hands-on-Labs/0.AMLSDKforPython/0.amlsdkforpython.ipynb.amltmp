{
  "cells": [
    {
      "cell_type": "markdown",
      "source": [
        "## Azure Machine Learning SDK for Python\n",
        "\n",
        "Sources from __[What is the Azure Machine Learning SDK for Python?](https://docs.microsoft.com/en-us/python/api/overview/azure/ml/?view=azure-ml-py)__\n",
        "\n",
        "Key areas of the SDK include:\n",
        "\n",
        "- Explore, prepare and manage the lifecycle of your datasets used in machine learning experiments.\n",
        "- Manage cloud resources for monitoring, logging, and organizing your machine learning experiments.\n",
        "- Train models either locally or by using cloud resources, including GPU-accelerated model training.\n",
        "- Use automated machine learning, which accepts configuration parameters and training data. It automatically iterates through algorithms and hyperparameter settings to find the best model for running predictions.\n",
        "- Deploy web services to convert your trained models into RESTful services that can be consumed in any application.\n",
        "\n",
        "\n",
        "AML SDK for Python Namespace:\n",
        "* Workspace\n",
        "* Dataset\n",
        "* Experiment\n",
        "* Run\n",
        "* Model\n",
        "* ComputeTarget\n",
        "* RunConfiguration\n",
        "* ScriptRunConfig\n",
        "* Environment\n",
        "* Pipeline\n",
        "* PythonScriptStep\n",
        "\n",
        "![AMLWorkspace](https://docs.microsoft.com/en-us/azure/machine-learning/media/concept-workspace/azure-machine-learning-taxonomy.png#lightbox)\n"
      ],
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Check version of the SDK"
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "import azureml.core\n",
        "\n",
        "\n",
        "print(\"Azure Machine Learning SDK for python version {0}\".format(azureml.core.VERSION))"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "Azure Machine Learning SDK for python version 1.37.0\n"
        }
      ],
      "execution_count": 1,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Workspace\n",
        "\n",
        "### azureml.core.workspace.Workspace\n",
        "\n",
        "Create AML Workspace\n",
        "\n",
        "```python\n",
        "from azureml.core import Workspace\n",
        "ws = Workspace.create(name='myworkspace',\n",
        "           subscription_id='<azure-subscription-id>',\n",
        "           resource_group='myresourcegroup',\n",
        "           create_resource_group=True,\n",
        "           location='eastus2'\n",
        "           )\n",
        "```\n",
        "\n",
        "__Get workspace object__\n",
        "\n",
        "```python\n",
        "from azureml.core import Workspace\n",
        "\n",
        "ws = Workspace.get(name=\"myworkspace\",\n",
        "            subscription_id='<azure-subscription-id>',\n",
        "            resource_group='myresourcegroup')\n",
        "```"
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "from azureml.core import Workspace\n",
        "\n",
        "\n",
        "# Read from '.azureml/' in the current working directory and 'config.json' file\n",
        "ws = Workspace.from_config()\n",
        "\n",
        "ws.get_details()"
      ],
      "outputs": [
        {
          "output_type": "execute_result",
          "execution_count": 1,
          "data": {
            "text/plain": "{'id': '/subscriptions/89da9f33-fd31-4ece-861e-5fab7af4dc11/resourceGroups/mtcs-dev-aml-rg/providers/Microsoft.MachineLearningServices/workspaces/mtcs-dev-aml',\n 'name': 'mtcs-dev-aml',\n 'identity': {'principal_id': '825a800c-aeb0-41be-945e-3caf8d9b5f19',\n  'tenant_id': '72f988bf-86f1-41af-91ab-2d7cd011db47',\n  'type': 'SystemAssigned'},\n 'location': 'westus2',\n 'type': 'Microsoft.MachineLearningServices/workspaces',\n 'tags': {},\n 'sku': 'Basic',\n 'workspaceid': '55f81537-6bfe-40ca-8b34-4b2093de7c9e',\n 'sdkTelemetryAppInsightsKey': '19f24253-9564-406c-9a1e-a48a21b145aa',\n 'description': '',\n 'friendlyName': 'mtcs-dev-aml',\n 'creationTime': '2020-08-04T22:57:58.9401208+00:00',\n 'containerRegistry': '/subscriptions/89da9f33-fd31-4ece-861e-5fab7af4dc11/resourcegroups/mtcs-dev-aml-rg/providers/microsoft.containerregistry/registries/mtcsdevamlcr',\n 'adbWorkspace': '/subscriptions/89da9f33-fd31-4ece-861e-5fab7af4dc11/resourceGroups/mtcs-dev-adb-rg/providers/Microsoft.Databricks/workspaces/hyun-dev-adb westus2',\n 'keyVault': '/subscriptions/89da9f33-fd31-4ece-861e-5fab7af4dc11/resourcegroups/mtcs-dev-aml-rg/providers/microsoft.keyvault/vaults/mtcsdev-aml-kv',\n 'applicationInsights': '/subscriptions/89da9f33-fd31-4ece-861e-5fab7af4dc11/resourcegroups/mtcs-dev-aml-rg/providers/microsoft.insights/components/mtcsdev-aml-ai',\n 'storageAccount': '/subscriptions/89da9f33-fd31-4ece-861e-5fab7af4dc11/resourcegroups/mtcs-dev-aml-rg/providers/microsoft.storage/storageaccounts/mtcsdevamlsa',\n 'hbiWorkspace': False,\n 'allowPublicAccessWhenBehindVnet': False,\n 'provisioningState': 'Succeeded',\n 'imageBuildCompute': '',\n 'discoveryUrl': 'https://westus2.api.azureml.ms/discovery',\n 'notebookInfo': {'fqdn': 'ml-mtcs-dev-aml-westus2-55f81537-6bfe-40ca-8b34-4b2093de7c9e.notebooks.azure.net',\n  'resource_id': 'e743f70d55b74fe6bf59ea36c1036fe5'}}"
          },
          "metadata": {}
        }
      ],
      "execution_count": 1,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "fs = open('./.azureml/config.json')\n",
        "\n",
        "print(fs.read())"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "{\"Id\": null, \"Scope\": \"/subscriptions/89da9f33-fd31-4ece-861e-5fab7af4dc11/resourceGroups/mtcs-dev-aml-rg/providers/Microsoft.MachineLearningServices/workspaces/mtcs-dev-aml\"}\n"
        }
      ],
      "execution_count": 3,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Datastore and DataSet\n"
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "csvfile = 'diabetes.csv'"
      ],
      "outputs": [],
      "execution_count": 71,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "from azureml.core import Datastore\n",
        "\n",
        "datastore_name = 'workspaceblobstore' # Update the value with your datastore name\n",
        "\n",
        "# retrieve an existing datastore in the workspace by name\n",
        "datastore = Datastore.get(ws, datastore_name)\n",
        "datastore"
      ],
      "outputs": [
        {
          "output_type": "execute_result",
          "execution_count": 82,
          "data": {
            "text/plain": "{\n  \"name\": \"workspaceblobstore\",\n  \"container_name\": \"azureml-blobstore-55f81537-6bfe-40ca-8b34-4b2093de7c9e\",\n  \"account_name\": \"mtcsdevamlsa\",\n  \"protocol\": \"https\",\n  \"endpoint\": \"core.windows.net\"\n}"
          },
          "metadata": {}
        }
      ],
      "execution_count": 82,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "file_datastore = datastore.upload('./data', 'data', overwrite=True)"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "Uploading an estimated of 1 files\nUploading ./data/diabetes.csv\nUploaded ./data/diabetes.csv, 1 files out of an estimated total of 1\nUploaded 1 files\n"
        }
      ],
      "execution_count": 74,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "from azureml.core import Dataset\n",
        "\n",
        "ds = Dataset.File.from_files(path=[(datastore,'./data/diabetes.csv')])\n",
        "ds.register(ws, 'diabetes', create_new_version=True)"
      ],
      "outputs": [
        {
          "output_type": "execute_result",
          "execution_count": 81,
          "data": {
            "text/plain": "{\n  \"source\": [\n    \"('workspaceblobstore', './data/diabetes.csv')\"\n  ],\n  \"definition\": [\n    \"GetDatastoreFiles\"\n  ],\n  \"registration\": {\n    \"id\": \"609ceedf-1263-404e-bc7a-4ae357c0c93c\",\n    \"name\": \"diabetes\",\n    \"version\": 2,\n    \"workspace\": \"Workspace.create(name='mtcs-dev-aml', subscription_id='89da9f33-fd31-4ece-861e-5fab7af4dc11', resource_group='mtcs-dev-aml-rg')\"\n  }\n}"
          },
          "metadata": {}
        }
      ],
      "execution_count": 81,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Experiment\n",
        "\n",
        "### azureml.core.experiment.Experiment\n",
        "\n",
        "The Experiment class is another foundational cloud resource that represents a collection of trials (individual model runs). The following code fetches an Experiment object from within Workspace by name, or it creates a new Experiment object if the name doesn't exist.\n"
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "from azureml.core.experiment import Experiment\n",
        "\n",
        "expName = \"mtc-aml-lab-exp\"\n",
        "exp = Experiment(workspace=ws, name=expName)\n",
        "exp"
      ],
      "outputs": [
        {
          "output_type": "execute_result",
          "execution_count": 2,
          "data": {
            "text/html": "<table style=\"width:100%\"><tr><th>Name</th><th>Workspace</th><th>Report Page</th><th>Docs Page</th></tr><tr><td>mtc-aml-lab-exp</td><td>mtcs-dev-aml</td><td><a href=\"https://ml.azure.com/experiments/id/feaacf3d-d47f-44d2-8dfc-744f762fa446?wsid=/subscriptions/89da9f33-fd31-4ece-861e-5fab7af4dc11/resourcegroups/mtcs-dev-aml-rg/workspaces/mtcs-dev-aml&amp;tid=72f988bf-86f1-41af-91ab-2d7cd011db47\" target=\"_blank\" rel=\"noopener\">Link to Azure Machine Learning studio</a></td><td><a href=\"https://docs.microsoft.com/en-us/python/api/azureml-core/azureml.core.experiment.Experiment?view=azure-ml-py\" target=\"_blank\" rel=\"noopener\">Link to Documentation</a></td></tr></table>",
            "text/plain": "Experiment(Name: mtc-aml-lab-exp,\nWorkspace: mtcs-dev-aml)"
          },
          "metadata": {}
        }
      ],
      "execution_count": 2,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "exp.tag(\"projectName\",\"AML-Lab\")\n",
        "exp.tag(\"MTCLocation\",\"Seattle\")\n",
        "exp.tag(\"MTCTeam\",\"MTCS\")\n",
        "exp.tag(\"MTCTeam\",\"MTC Seattle\") # Careful, tags are mutable"
      ],
      "outputs": [],
      "execution_count": 5,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "list_experiments = Experiment.list(ws)\n",
        "list_experiments"
      ],
      "outputs": [],
      "execution_count": null,
      "metadata": {
        "scrolled": true
      }
    },
    {
      "cell_type": "code",
      "source": [
        "for experiment in list_experiments:\n",
        "    if experiment.name == expName:\n",
        "        print(experiment.name) \n",
        "        print(experiment.tags)\n",
        "\n",
        "# Check the value of key 'Team'"
      ],
      "outputs": [],
      "execution_count": null,
      "metadata": {
        "scrolled": true
      }
    },
    {
      "cell_type": "code",
      "source": [
        "list_runs = exp.get_runs()\n",
        "\n",
        "for run in list_runs:\n",
        "    print(run.id)"
      ],
      "outputs": [],
      "execution_count": 6,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "There are two ways to execute an experiment trial. \n",
        "\n",
        "If you're interactively experimenting in a Jupyter notebook, use the `start_logging` function. \n",
        "\n",
        "If you're submitting an experiment from a standard Python environment, use the `submit` function. \n",
        "\n",
        "Both functions return a Run object. The experiment variable represents an Experiment object in the following code examples."
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "run = exp.start_logging()\n",
        "run"
      ],
      "outputs": [
        {
          "output_type": "execute_result",
          "execution_count": 22,
          "data": {
            "text/html": "<table style=\"width:100%\"><tr><th>Experiment</th><th>Id</th><th>Type</th><th>Status</th><th>Details Page</th><th>Docs Page</th></tr><tr><td>mtc-aml-lab-exp</td><td>7ea2acca-a102-4d37-9cfa-5c0adfe61208</td><td></td><td>Running</td><td><a href=\"https://ml.azure.com/runs/7ea2acca-a102-4d37-9cfa-5c0adfe61208?wsid=/subscriptions/89da9f33-fd31-4ece-861e-5fab7af4dc11/resourcegroups/mtcs-dev-aml-rg/workspaces/mtcs-dev-aml&amp;tid=72f988bf-86f1-41af-91ab-2d7cd011db47\" target=\"_blank\" rel=\"noopener\">Link to Azure Machine Learning studio</a></td><td><a href=\"https://docs.microsoft.com/en-us/python/api/azureml-core/azureml.core.run.Run?view=azure-ml-py\" target=\"_blank\" rel=\"noopener\">Link to Documentation</a></td></tr></table>",
            "text/plain": "Run(Experiment: mtc-aml-lab-exp,\nId: 7ea2acca-a102-4d37-9cfa-5c0adfe61208,\nType: None,\nStatus: Running)"
          },
          "metadata": {}
        }
      ],
      "execution_count": 22,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "list_runs = exp.get_runs()\n",
        "\n",
        "for run in list_runs:\n",
        "    print(run)"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "Run(Experiment: mtc-aml-lab-exp,\nId: db0262dc-7a57-4138-a6ec-7a48ef6b73c9,\nType: None,\nStatus: Running)\n"
        }
      ],
      "execution_count": 8,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Run\n",
        "\n",
        "### azureml.core.run.Run\n",
        "\n",
        "A run represents a single trial of an experiment. Run is the object that you use to monitor the asynchronous execution of a trial, store the output of the trial, analyze results, and access generated artifacts. You use Run inside your experimentation code to log metrics and artifacts to the Run History service. Functionality includes:\n",
        "\n",
        "- Storing and retrieving metrics and data.\n",
        "- Using tags and the child hierarchy for easy lookup of past runs.\n",
        "- Registering stored model files for deployment.\n",
        "- Storing, modifying, and retrieving properties of a run.\n",
        "\n",
        "Create a Run object by submitting an Experiment object with a run configuration object. Use the tags parameter to attach custom categories and labels to your runs. You can easily find and retrieve them later from Experiment.\n"
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "# run = experiment.submit(config=your_config_object, tags=tags)\n",
        "\n",
        "run.tag(\"owner\",\"hyun\")\n",
        "run.tag(\"build\",\"dev\")\n",
        "run.tag(\"codeVersion\",1) # Integer or string for value"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stderr",
          "text": "Converting non-string tag to string: (codeVersion: 1)\n"
        }
      ],
      "execution_count": 23,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "print(run)"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "Run(Experiment: mtc-aml-lab-exp,\nId: db0262dc-7a57-4138-a6ec-7a48ef6b73c9,\nType: None,\nStatus: Running)\n"
        }
      ],
      "execution_count": 10,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "from azureml.core.run import Run\n",
        "\n",
        "filtered_list_runs = Run.list(exp, tags={\"owner\":\"hyun\", \"build\":\"dev\"})\n",
        "\n",
        "for filtered_run in filtered_list_runs:\n",
        "    print(filtered_run)\n",
        "    print(filtered_run.tags)"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "Run(Experiment: mtc-aml-lab-exp,\nId: db0262dc-7a57-4138-a6ec-7a48ef6b73c9,\nType: None,\nStatus: Running)\n{'owner': 'hyun', 'build': 'dev', 'codeVersion': '1'}\n"
        }
      ],
      "execution_count": 11,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "run_details = run.get_details()\n",
        "run_details"
      ],
      "outputs": [
        {
          "output_type": "execute_result",
          "execution_count": 12,
          "data": {
            "text/plain": "{'runId': 'db0262dc-7a57-4138-a6ec-7a48ef6b73c9',\n 'target': 'local',\n 'status': 'Running',\n 'startTimeUtc': '2022-03-01T07:25:41.922778Z',\n 'services': {},\n 'properties': {'azureml.git.repository_uri': 'https://github.com/hyssh/mtc-open-workshop.git',\n  'mlflow.source.git.repoURL': 'https://github.com/hyssh/mtc-open-workshop.git',\n  'azureml.git.branch': 'master',\n  'mlflow.source.git.branch': 'master',\n  'azureml.git.commit': '971b75559670c5ff8880ddd2b70372227a814603',\n  'mlflow.source.git.commit': '971b75559670c5ff8880ddd2b70372227a814603',\n  'azureml.git.dirty': 'True',\n  'ContentSnapshotId': '5eb990c6-bb4a-4a25-934a-b4213668b1ff'},\n 'inputDatasets': [],\n 'outputDatasets': [],\n 'logFiles': {},\n 'submittedBy': 'Hyun Suk Shin (MTC SEATTLE)'}"
          },
          "metadata": {}
        }
      ],
      "execution_count": 12,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "Output for this function is a dictionary that includes:\n",
        "\n",
        "- Run ID\n",
        "- Status\n",
        "- Start and end time\n",
        "- Compute target (local versus cloud)\n",
        "- Dependencies and versions used in the run\n",
        "- Training-specific data (differs depending on model type)"
      ],
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "### Upload file/s to AML using RUN"
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "run.upload_file(name='aml-lab/workshop.ipynb', path_or_stream=\"./0.AMLSDKforPython.ipynb\")\n",
        "\n",
        "# Go to 'Run' > 'Outputs + Logs' in Experiment of Azure Machine Learning"
      ],
      "outputs": [
        {
          "output_type": "execute_result",
          "execution_count": 24,
          "data": {
            "text/plain": "<azureml._restclient.models.batch_artifact_content_information_dto.BatchArtifactContentInformationDto at 0x7f721415fac0>"
          },
          "metadata": {}
        }
      ],
      "execution_count": 24,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "### Logging metrics using RUN"
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "run.log_list(name='Fibonacci', value=[0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89])"
      ],
      "outputs": [],
      "execution_count": 14,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "import numpy as np\n",
        "\n",
        "\n",
        "for i in (range(-10, 10)): \n",
        "    run.log(name='Sigmoid', value=1 / (1 + np.exp(-i)))\n",
        "    angle = i / 2.0"
      ],
      "outputs": [],
      "execution_count": 15,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "for i in (range(-10, 10)):\n",
        "    angle = i / 2.0\n",
        "    run.log_row(name='Cosine Wave', angle=angle, cos=np.cos(angle))\n"
      ],
      "outputs": [],
      "execution_count": 16,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "citrus = ['orange', 'lemon', 'lime']\n",
        "sizes = [ 10, 7, 3]\n",
        "\n",
        "for index in range(len(citrus)):\n",
        "    run.log_row(\"citrus\", fruit = citrus[index], size=sizes[index])"
      ],
      "outputs": [],
      "execution_count": 17,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "run.log_image(name='AML Concept Whiteboard', path='./AML_concept.png', plot=None, description='Discussion lead by Hyun at MTC Seattle')"
      ],
      "outputs": [],
      "execution_count": 19,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "metrics = run.get_metrics()\n",
        "# metrics is of type Dict[str, List[float]] mapping metric names\n",
        "# to a list of the values for that metric in the given run.\n",
        "\n",
        "print(metrics)"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "{'Fibonacci': [0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89], 'Sigmoid': [4.5397868702434395e-05, 0.00012339457598623172, 0.0003353501304664781, 0.0009110511944006454, 0.0024726231566347743, 0.0066928509242848554, 0.01798620996209156, 0.04742587317756678, 0.11920292202211755, 0.2689414213699951, 0.5, 0.7310585786300049, 0.8807970779778823, 0.9525741268224334, 0.9820137900379085, 0.9933071490757153, 0.9975273768433653, 0.9990889488055994, 0.9996646498695336, 0.9998766054240137], 'Cosine Wave': {'angle': [-5.0, -4.5, -4.0, -3.5, -3.0, -2.5, -2.0, -1.5, -1.0, -0.5, 0.0, 0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5], 'cos': [0.28366218546322625, -0.2107957994307797, -0.6536436208636119, -0.9364566872907963, -0.9899924966004454, -0.8011436155469337, -0.4161468365471424, 0.0707372016677029, 0.5403023058681398, 0.8775825618903728, 1.0, 0.8775825618903728, 0.5403023058681398, 0.0707372016677029, -0.4161468365471424, -0.8011436155469337, -0.9899924966004454, -0.9364566872907963, -0.6536436208636119, -0.2107957994307797]}, 'citrus': {'fruit': ['orange', 'lemon', 'lime'], 'size': [10, 7, 3]}, 'AML Concept Whiteboard': 'aml://artifactId/ExperimentRun/dcid.db0262dc-7a57-4138-a6ec-7a48ef6b73c9/./AML_concept.png'}\n"
        }
      ],
      "execution_count": 20,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "run.complete()\n",
        "# run.cancel()"
      ],
      "outputs": [
        {
          "output_type": "error",
          "ename": "ServiceException",
          "evalue": "ServiceException:\n\tCode: 400\n\tMessage: (UserError) Run with id compute_target_test_1646123827_f7b9f0c7 is in a terminal state and cannot be updated.\n\tDetails:\n\n\tHeaders: {\n\t    \"Date\": \"Tue, 01 Mar 2022 08:40:22 GMT\",\n\t    \"Content-Type\": \"application/json; charset=utf-8\",\n\t    \"Content-Length\": \"898\",\n\t    \"Connection\": \"keep-alive\",\n\t    \"Request-Context\": \"appId=cid-v1:2d2e8e63-272e-4b3c-8598-4ee570a0e70d\",\n\t    \"x-ms-response-type\": \"error\",\n\t    \"Strict-Transport-Security\": \"max-age=15724800; includeSubDomains; preload\",\n\t    \"X-Content-Type-Options\": \"nosniff\",\n\t    \"x-request-time\": \"0.036\"\n\t}\n\tInnerException: {\n    \"additional_properties\": {},\n    \"error\": {\n        \"additional_properties\": {\n            \"debugInfo\": null\n        },\n        \"code\": \"UserError\",\n        \"severity\": null,\n        \"message\": \"Run with id compute_target_test_1646123827_f7b9f0c7 is in a terminal state and cannot be updated.\",\n        \"message_format\": \"Run with id {runId} is in a terminal state and cannot be updated.\",\n        \"message_parameters\": {\n            \"runId\": \"compute_target_test_1646123827_f7b9f0c7\"\n        },\n        \"reference_code\": null,\n        \"details_uri\": null,\n        \"target\": null,\n        \"details\": [],\n        \"inner_error\": {\n            \"additional_properties\": {},\n            \"code\": \"BadArgument\",\n            \"inner_error\": {\n                \"additional_properties\": {},\n                \"code\": \"TerminalRunState\",\n                \"inner_error\": null\n            }\n        },\n        \"additional_info\": null\n    },\n    \"correlation\": {\n        \"operation\": \"22de665b996bd7555657231db9866732\",\n        \"request\": \"5a64625575f8d25c\"\n    },\n    \"environment\": \"westus2\",\n    \"location\": \"westus2\",\n    \"time\": {},\n    \"component_name\": \"run-history\"\n}",
          "traceback": [
            "\u001b[0;31m---------------------------------------------------------------------------\u001b[0m",
            "\u001b[0;31mErrorResponseException\u001b[0m                    Traceback (most recent call last)",
            "\u001b[0;32m/anaconda/envs/azureml_py38/lib/python3.8/site-packages/azureml/_restclient/clientbase.py\u001b[0m in \u001b[0;36m_execute_with_arguments\u001b[0;34m(self, func, args_list, *args, **kwargs)\u001b[0m\n\u001b[1;32m    588\u001b[0m             \u001b[0;32melse\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 589\u001b[0;31m                 \u001b[0;32mreturn\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_call_api\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mfunc\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m*\u001b[0m\u001b[0margs_list\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m**\u001b[0m\u001b[0mkwargs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    590\u001b[0m         \u001b[0;32mexcept\u001b[0m \u001b[0mErrorResponseException\u001b[0m \u001b[0;32mas\u001b[0m \u001b[0me\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n",
            "\u001b[0;32m/anaconda/envs/azureml_py38/lib/python3.8/site-packages/azureml/_restclient/clientbase.py\u001b[0m in \u001b[0;36m_call_api\u001b[0;34m(self, func, *args, **kwargs)\u001b[0m\n\u001b[1;32m    244\u001b[0m             \u001b[0;32melse\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 245\u001b[0;31m                 \u001b[0;32mreturn\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_execute_with_base_arguments\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mfunc\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m*\u001b[0m\u001b[0margs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m**\u001b[0m\u001b[0mkwargs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    246\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n",
            "\u001b[0;32m/anaconda/envs/azureml_py38/lib/python3.8/site-packages/azureml/_restclient/clientbase.py\u001b[0m in \u001b[0;36m_execute_with_base_arguments\u001b[0;34m(self, func, *args, **kwargs)\u001b[0m\n\u001b[1;32m    332\u001b[0m         \u001b[0mtotal_retry\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0;36m0\u001b[0m \u001b[0;32mif\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mretries\u001b[0m \u001b[0;34m<\u001b[0m \u001b[0;36m0\u001b[0m \u001b[0;32melse\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mretries\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 333\u001b[0;31m         return ClientBase._execute_func_internal(\n\u001b[0m\u001b[1;32m    334\u001b[0m             back_off, total_retry, self._logger, func, _noop_reset, *args, **kwargs)\n",
            "\u001b[0;32m/anaconda/envs/azureml_py38/lib/python3.8/site-packages/azureml/_restclient/clientbase.py\u001b[0m in \u001b[0;36m_execute_func_internal\u001b[0;34m(cls, back_off, total_retry, logger, func, reset_func, *args, **kwargs)\u001b[0m\n\u001b[1;32m    366\u001b[0m             \u001b[0;32mexcept\u001b[0m \u001b[0mException\u001b[0m \u001b[0;32mas\u001b[0m \u001b[0merror\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 367\u001b[0;31m                 \u001b[0mleft_retry\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mcls\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_handle_retry\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mback_off\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mleft_retry\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mtotal_retry\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0merror\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mlogger\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mfunc\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    368\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n",
            "\u001b[0;32m/anaconda/envs/azureml_py38/lib/python3.8/site-packages/azureml/_restclient/clientbase.py\u001b[0m in \u001b[0;36m_handle_retry\u001b[0;34m(cls, back_off, left_retry, total_retry, error, logger, func)\u001b[0m\n\u001b[1;32m    425\u001b[0m             \u001b[0;32melif\u001b[0m \u001b[0merror\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mresponse\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mstatus_code\u001b[0m \u001b[0;34m<\u001b[0m \u001b[0;36m500\u001b[0m \u001b[0;32mand\u001b[0m \u001b[0merror\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mresponse\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mstatus_code\u001b[0m \u001b[0;34m!=\u001b[0m \u001b[0;36m408\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 426\u001b[0;31m                 \u001b[0;32mraise\u001b[0m \u001b[0merror\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    427\u001b[0m         \u001b[0;32melif\u001b[0m \u001b[0misinstance\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0merror\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mClientRequestError\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n",
            "\u001b[0;32m/anaconda/envs/azureml_py38/lib/python3.8/site-packages/azureml/_restclient/clientbase.py\u001b[0m in \u001b[0;36m_execute_func_internal\u001b[0;34m(cls, back_off, total_retry, logger, func, reset_func, *args, **kwargs)\u001b[0m\n\u001b[1;32m    357\u001b[0m                 \u001b[0mlogger\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mdebug\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m\"ClientBase: Calling {} with url {}\"\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mformat\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mfunc_name\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mfunc_url\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 358\u001b[0;31m                 \u001b[0mresponse\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mfunc\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m*\u001b[0m\u001b[0margs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m**\u001b[0m\u001b[0mkwargs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    359\u001b[0m                 if (isinstance(response, Response) and cls._is_retryable_status_code(response.status_code) and\n",
            "\u001b[0;32m/anaconda/envs/azureml_py38/lib/python3.8/site-packages/azureml/_restclient/operations/events_operations.py\u001b[0m in \u001b[0;36mpost\u001b[0;34m(self, subscription_id, resource_group_name, workspace_name, experiment_name, run_id, event_message, custom_headers, raw, **operation_config)\u001b[0m\n\u001b[1;32m     94\u001b[0m         \u001b[0;32mif\u001b[0m \u001b[0mresponse\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mstatus_code\u001b[0m \u001b[0;32mnot\u001b[0m \u001b[0;32min\u001b[0m \u001b[0;34m[\u001b[0m\u001b[0;36m200\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m---> 95\u001b[0;31m             \u001b[0;32mraise\u001b[0m \u001b[0mmodels\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mErrorResponseException\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_deserialize\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mresponse\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m     96\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n",
            "\u001b[0;31mErrorResponseException\u001b[0m: (UserError) Run with id compute_target_test_1646123827_f7b9f0c7 is in a terminal state and cannot be updated.",
            "\nDuring handling of the above exception, another exception occurred:\n",
            "\u001b[0;31mServiceException\u001b[0m                          Traceback (most recent call last)",
            "\u001b[0;32m<ipython-input-32-36d15cd0f2ea>\u001b[0m in \u001b[0;36m<module>\u001b[0;34m\u001b[0m\n\u001b[0;32m----> 1\u001b[0;31m \u001b[0mrun\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mcomplete\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m      2\u001b[0m \u001b[0;31m# run.cancel()\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n",
            "\u001b[0;32m/anaconda/envs/azureml_py38/lib/python3.8/site-packages/azureml/core/run.py\u001b[0m in \u001b[0;36mcomplete\u001b[0;34m(self, _set_status)\u001b[0m\n\u001b[1;32m   1391\u001b[0m         \u001b[0;34m:\u001b[0m\u001b[0mtype\u001b[0m \u001b[0m_set_status\u001b[0m\u001b[0;34m:\u001b[0m \u001b[0mbool\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   1392\u001b[0m         \"\"\"\n\u001b[0;32m-> 1393\u001b[0;31m         \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_client\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mcomplete\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0m_set_status\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0m_set_status\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m   1394\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   1395\u001b[0m     \u001b[0;32mdef\u001b[0m \u001b[0mfail\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0merror_details\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mNone\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0merror_code\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mNone\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0m_set_status\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mTrue\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n",
            "\u001b[0;32m/anaconda/envs/azureml_py38/lib/python3.8/site-packages/azureml/_run_impl/run_history_facade.py\u001b[0m in \u001b[0;36mcomplete\u001b[0;34m(self, _set_status)\u001b[0m\n\u001b[1;32m    619\u001b[0m         \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mflush\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    620\u001b[0m         \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mupload_tracked_files\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 621\u001b[0;31m         \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mset_completed_status\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0m_set_status\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0m_set_status\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    622\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    623\u001b[0m     \u001b[0;32mdef\u001b[0m \u001b[0mset_completed_status\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0m_set_status\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n",
            "\u001b[0;32m/anaconda/envs/azureml_py38/lib/python3.8/site-packages/azureml/_run_impl/run_history_facade.py\u001b[0m in \u001b[0;36mset_completed_status\u001b[0;34m(self, _set_status)\u001b[0m\n\u001b[1;32m    623\u001b[0m     \u001b[0;32mdef\u001b[0m \u001b[0mset_completed_status\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0m_set_status\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    624\u001b[0m         \u001b[0;32mif\u001b[0m \u001b[0m_set_status\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 625\u001b[0;31m             \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mrun\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mpost_event_completed\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mcaller\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0midentity\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    626\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    627\u001b[0m     \u001b[0;32mdef\u001b[0m \u001b[0mfail\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0merror_details\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mNone\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0merror_code\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mNone\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0m_set_status\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mTrue\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n",
            "\u001b[0;32m/anaconda/envs/azureml_py38/lib/python3.8/site-packages/azureml/_restclient/run_client.py\u001b[0m in \u001b[0;36mpost_event_completed\u001b[0;34m(self, caller, custom_headers, is_async)\u001b[0m\n\u001b[1;32m    382\u001b[0m         \"\"\"\n\u001b[1;32m    383\u001b[0m         \u001b[0mevent\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mcreate_completed_event\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_run_id\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 384\u001b[0;31m         \u001b[0;32mreturn\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mpost_event\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mevent\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mis_async\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0mis_async\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mcaller\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0mcaller\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mcustom_headers\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0mcustom_headers\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    385\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    386\u001b[0m     \u001b[0;32mdef\u001b[0m \u001b[0mpost_event_failed\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mcaller\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mNone\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mcustom_headers\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mNone\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mis_async\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mFalse\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n",
            "\u001b[0;32m/anaconda/envs/azureml_py38/lib/python3.8/site-packages/azureml/_restclient/run_client.py\u001b[0m in \u001b[0;36mpost_event\u001b[0;34m(self, event, caller, custom_headers, is_async)\u001b[0m\n\u001b[1;32m    314\u001b[0m                                          custom_headers=custom_headers, is_async=is_async)\n\u001b[1;32m    315\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 316\u001b[0;31m         \u001b[0;32mreturn\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_execute_with_run_arguments\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_client\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mevents\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mpost\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m**\u001b[0m\u001b[0mkwargs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    317\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    318\u001b[0m     \u001b[0;32mdef\u001b[0m \u001b[0mbatch_post_event_start\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mrun_ids\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mcaller\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mNone\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mcustom_headers\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mNone\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mis_async\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mFalse\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n",
            "\u001b[0;32m/anaconda/envs/azureml_py38/lib/python3.8/site-packages/azureml/_restclient/run_client.py\u001b[0m in \u001b[0;36m_execute_with_run_arguments\u001b[0;34m(self, func, *args, **kwargs)\u001b[0m\n\u001b[1;32m    562\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    563\u001b[0m     \u001b[0;32mdef\u001b[0m \u001b[0m_execute_with_run_arguments\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mfunc\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m*\u001b[0m\u001b[0margs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m**\u001b[0m\u001b[0mkwargs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 564\u001b[0;31m         \u001b[0;32mreturn\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_execute_with_arguments\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mfunc\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mcopy\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mdeepcopy\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_run_arguments\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m*\u001b[0m\u001b[0margs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m**\u001b[0m\u001b[0mkwargs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    565\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    566\u001b[0m     \u001b[0;32mdef\u001b[0m \u001b[0m_execute_with_run_expid_arguments\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mfunc\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m*\u001b[0m\u001b[0margs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m**\u001b[0m\u001b[0mkwargs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n",
            "\u001b[0;32m/anaconda/envs/azureml_py38/lib/python3.8/site-packages/azureml/_restclient/clientbase.py\u001b[0m in \u001b[0;36m_execute_with_arguments\u001b[0;34m(self, func, args_list, *args, **kwargs)\u001b[0m\n\u001b[1;32m    589\u001b[0m                 \u001b[0;32mreturn\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_call_api\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mfunc\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m*\u001b[0m\u001b[0margs_list\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m**\u001b[0m\u001b[0mkwargs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    590\u001b[0m         \u001b[0;32mexcept\u001b[0m \u001b[0mErrorResponseException\u001b[0m \u001b[0;32mas\u001b[0m \u001b[0me\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 591\u001b[0;31m             \u001b[0;32mraise\u001b[0m \u001b[0mServiceException\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0me\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m",
            "\u001b[0;31mServiceException\u001b[0m: ServiceException:\n\tCode: 400\n\tMessage: (UserError) Run with id compute_target_test_1646123827_f7b9f0c7 is in a terminal state and cannot be updated.\n\tDetails:\n\n\tHeaders: {\n\t    \"Date\": \"Tue, 01 Mar 2022 08:40:22 GMT\",\n\t    \"Content-Type\": \"application/json; charset=utf-8\",\n\t    \"Content-Length\": \"898\",\n\t    \"Connection\": \"keep-alive\",\n\t    \"Request-Context\": \"appId=cid-v1:2d2e8e63-272e-4b3c-8598-4ee570a0e70d\",\n\t    \"x-ms-response-type\": \"error\",\n\t    \"Strict-Transport-Security\": \"max-age=15724800; includeSubDomains; preload\",\n\t    \"X-Content-Type-Options\": \"nosniff\",\n\t    \"x-request-time\": \"0.036\"\n\t}\n\tInnerException: {\n    \"additional_properties\": {},\n    \"error\": {\n        \"additional_properties\": {\n            \"debugInfo\": null\n        },\n        \"code\": \"UserError\",\n        \"severity\": null,\n        \"message\": \"Run with id compute_target_test_1646123827_f7b9f0c7 is in a terminal state and cannot be updated.\",\n        \"message_format\": \"Run with id {runId} is in a terminal state and cannot be updated.\",\n        \"message_parameters\": {\n            \"runId\": \"compute_target_test_1646123827_f7b9f0c7\"\n        },\n        \"reference_code\": null,\n        \"details_uri\": null,\n        \"target\": null,\n        \"details\": [],\n        \"inner_error\": {\n            \"additional_properties\": {},\n            \"code\": \"BadArgument\",\n            \"inner_error\": {\n                \"additional_properties\": {},\n                \"code\": \"TerminalRunState\",\n                \"inner_error\": null\n            }\n        },\n        \"additional_info\": null\n    },\n    \"correlation\": {\n        \"operation\": \"22de665b996bd7555657231db9866732\",\n        \"request\": \"5a64625575f8d25c\"\n    },\n    \"environment\": \"westus2\",\n    \"location\": \"westus2\",\n    \"time\": {},\n    \"component_name\": \"run-history\"\n}"
          ]
        }
      ],
      "execution_count": 32,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Model\n",
        "\n",
        "### azureml.core.model.Model\n",
        "\n",
        "The `Model` class is used for working with cloud representations of machine learning models. Methods help you transfer models between local development environments and the `Workspace` object in the cloud.\n",
        "\n",
        "You can use model registration to store and version your models in the Azure cloud, in your workspace. Registered models are identified by name and version. Each time you register a model with the same name as an existing one, the registry increments the version. Azure Machine Learning supports any model that can be loaded through Python 3, not just Azure Machine Learning models.\n",
        "\n",
        "The following example shows how to build a simple local classification model with `scikit-learn`, register the model in `Workspace`, and download the model from the cloud.\n",
        "\n",
        "Create a simple classifier, `clf`, to predict customer churn based on their age. Then dump the model to a `.pkl` file in the same directory."
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "from sklearn import svm\n",
        "import joblib\n",
        "import numpy as np\n",
        "\n",
        "# customer ages\n",
        "X_train = np.array([50, 17, 35, 23, 28, 40, 31, 29, 19, 62])\n",
        "X_train = X_train.reshape(-1, 1)\n",
        "# churn y/n\n",
        "y_train = [\"yes\", \"no\", \"no\", \"no\", \"yes\", \"yes\", \"yes\", \"no\", \"no\", \"yes\"]\n",
        "\n",
        "clf = svm.SVC(gamma=0.001, C=100.)\n",
        "clf.fit(X_train, y_train)\n",
        "\n",
        "joblib.dump(value=clf, filename=\"churn-model.pkl\")"
      ],
      "outputs": [
        {
          "output_type": "execute_result",
          "execution_count": 25,
          "data": {
            "text/plain": "['churn-model.pkl']"
          },
          "metadata": {}
        }
      ],
      "execution_count": 25,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "Use the `register` function to register the model in your workspace. Specify the local model path and the model name. Registering the same name more than once will create a new version."
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "from azureml.core.model import Model\n",
        "\n",
        "model = Model.register(workspace=ws,\n",
        "                       model_path=\"churn-model.pkl\",\n",
        "                       model_name=\"churn-model-test\")"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "Registering model churn-model-test\n"
        }
      ],
      "execution_count": 26,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "Now that the model is registered in your workspace, it's easy to manage, download, and organize your models. To retrieve a model (for example, in another environment) object from `Workspace`, use the class constructor and specify the model name and any optional parameters. Then, use the download function to `download` the model, including the cloud folder structure."
      ],
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Environment\n",
        "\n",
        "### azureml.core.environment.Environment\n",
        "\n",
        "Azure Machine Learning environments specify the Python packages, environment variables, and software settings around your training and scoring scripts. In addition to Python, you can also configure PySpark, Docker and R for environments. Internally, environments result in Docker images that are used to run the training and scoring processes on the compute target. The environments are managed and versioned entities within your Machine Learning workspace that enable reproducible, auditable, and portable machine learning workflows across a variety of compute targets and compute types.\n",
        "\n",
        "You can use an Environment object to:\n",
        "\n",
        "- Develop your training script.\n",
        "- Reuse the same environment on Azure Machine Learning Compute for model training at scale.\n",
        "- Deploy your model with that same environment without being tied to a specific compute type.\n",
        "\n",
        "The following code imports the Environment class from the SDK and to instantiates an environment object."
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "import sys\n",
        "from azureml.core.environment import Environment\n",
        "from azureml.core.conda_dependencies import CondaDependencies\n",
        "\n",
        "# pyVersion = f\"{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}\"\n",
        "icName = '' # <update the value with your Compute Instance Name>\n",
        "\n",
        "myenv = Environment(name=\"myEnv\")\n",
        "conda_dep = CondaDependencies()\n",
        "\n",
        "# Installs pillow package\n",
        "conda_dep.add_conda_package(\"numpy==1.17.0\")\n",
        "conda_dep.add_pip_package(\"scikit-learn\")\n",
        "conda_dep.add_pip_package(\"pillow\")\n",
        "\n",
        "\n",
        "# Adds dependencies to PythonSection of myenv\n",
        "myenv.python.conda_dependencies=conda_dep\n",
        "myenv.python.conda_dependencies.set_python_version(\"3.6\")\n",
        "myenv.register(ws)\n",
        "myenv.build(ws, icName)"
      ],
      "outputs": [
        {
          "output_type": "execute_result",
          "execution_count": 16,
          "data": {
            "text/plain": "<azureml.core.environment.ImageBuildDetails at 0x7f3850b9e0d0>"
          },
          "metadata": {}
        }
      ],
      "execution_count": 16,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "from azureml.core.model import Model\n",
        "import os\n",
        "\n",
        "model = Model(workspace=ws, name=\"churn-model-test\")\n",
        "model.download(target_dir=os.path.join(os.getcwd(),\"myDownload\"))"
      ],
      "outputs": [
        {
          "output_type": "execute_result",
          "execution_count": 27,
          "data": {
            "text/plain": "'/mnt/batch/tasks/shared/LS_root/mounts/clusters/hyssh1/code/Users/hyssh/mtc-open-workshop/Hands-on-Labs/0.AMLSDKforPython/myDownload/churn-model.pkl'"
          },
          "metadata": {}
        }
      ],
      "execution_count": 27,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "## ComputeTarget\n",
        "\n",
        "### azureml.core.compute.ComputeTarget\n",
        "\n",
        "The `ComputeTarget` class is the abstract parent class for creating and managing compute targets. A compute target represents a variety of resources where you can train your machine learning models. A compute target can be either a local machine or a cloud resource, such as Azure Machine Learning Compute, Azure HDInsight, or a remote virtual machine.\n",
        "\n",
        "Use compute targets to take advantage of powerful virtual machines for model training, and set up either persistent compute targets or temporary runtime-invoked targets. For a comprehensive guide on setting up and managing compute targets, see the how-to.\n",
        "\n",
        "The following code shows a simple example of setting up an `ComputeInstance` target. The resource scales automatically when a job is submitted. It's deleted automatically when the run finishes.\n",
        "\n",
        "Reuse the simple scikit-learn churn model and build it into its own file, train.py, in the current directory. At the end of the file, create a new directory called outputs. This step creates a directory in the cloud (your workspace) to store your trained model that joblib.dump() serialized."
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "from azureml.core.compute import ComputeInstance \n",
        "\n",
        "icName = ''\n",
        "myInstance = ComputeInstance(ws, icName)"
      ],
      "outputs": [],
      "execution_count": 4,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "## RunConfiguration\n",
        "\n",
        "### azureml.core.compute.RunConfiguration\n",
        "\n",
        "Next you create the compute target by instantiating a RunConfiguration object and setting the type and size. This example uses the smallest resource size (1 CPU core, 3.5 GB of memory). The list_vms variable contains a list of supported virtual machines and their sizes."
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "from azureml.core.runconfig import RunConfiguration\n",
        "\n",
        "compute_config = RunConfiguration()\n",
        "compute_config.target = myInstance\n",
        "compute_config"
      ],
      "outputs": [
        {
          "output_type": "execute_result",
          "execution_count": 11,
          "data": {
            "text/plain": "{\n    \"script\": null,\n    \"arguments\": [],\n    \"target\": \"hyssh1\",\n    \"framework\": \"Python\",\n    \"communicator\": \"None\",\n    \"maxRunDurationSeconds\": null,\n    \"nodeCount\": 1,\n    \"priority\": null,\n    \"environment\": {\n        \"name\": null,\n        \"version\": null,\n        \"environmentVariables\": {\n            \"EXAMPLE_ENV_VAR\": \"EXAMPLE_VALUE\"\n        },\n        \"python\": {\n            \"userManagedDependencies\": false,\n            \"interpreterPath\": \"python\",\n            \"condaDependenciesFile\": null,\n            \"baseCondaEnvironment\": null,\n            \"condaDependencies\": {\n                \"name\": \"project_environment\",\n                \"dependencies\": [\n                    \"python=3.6.2\",\n                    {\n                        \"pip\": [\n                            \"azureml-defaults\"\n                        ]\n                    }\n                ],\n                \"channels\": [\n                    \"anaconda\",\n                    \"conda-forge\"\n                ]\n            }\n        },\n        \"docker\": {\n            \"enabled\": false,\n            \"baseImage\": \"mcr.microsoft.com/azureml/openmpi3.1.2-ubuntu18.04:20211124.v1\",\n            \"baseDockerfile\": null,\n            \"sharedVolumes\": true,\n            \"shmSize\": \"2g\",\n            \"arguments\": [],\n            \"baseImageRegistry\": {\n                \"address\": null,\n                \"username\": null,\n                \"password\": null,\n                \"registryIdentity\": null\n            },\n            \"platform\": {\n                \"os\": \"Linux\",\n                \"architecture\": \"amd64\"\n            }\n        },\n        \"spark\": {\n            \"repositories\": [],\n            \"packages\": [],\n            \"precachePackages\": true\n        },\n        \"databricks\": {\n            \"mavenLibraries\": [],\n            \"pypiLibraries\": [],\n            \"rcranLibraries\": [],\n            \"jarLibraries\": [],\n            \"eggLibraries\": []\n        },\n        \"r\": null,\n        \"inferencingStackVersion\": null\n    },\n    \"history\": {\n        \"outputCollection\": true,\n        \"snapshotProject\": true,\n        \"directoriesToWatch\": [\n            \"logs\"\n        ]\n    },\n    \"spark\": {\n        \"configuration\": {\n            \"spark.app.name\": \"Azure ML Experiment\",\n            \"spark.yarn.maxAppAttempts\": 1\n        }\n    },\n    \"docker\": {\n        \"useDocker\": false,\n        \"sharedVolumes\": true,\n        \"arguments\": [],\n        \"shmSize\": \"2g\"\n    },\n    \"hdi\": {\n        \"yarnDeployMode\": \"cluster\"\n    },\n    \"tensorflow\": {\n        \"workerCount\": 1,\n        \"parameterServerCount\": 1\n    },\n    \"mpi\": {\n        \"processCountPerNode\": 1,\n        \"nodeCount\": 1\n    },\n    \"pytorch\": {\n        \"communicationBackend\": \"nccl\",\n        \"processCount\": null,\n        \"nodeCount\": 1\n    },\n    \"paralleltask\": {\n        \"maxRetriesPerWorker\": 0,\n        \"workerCountPerNode\": 1,\n        \"terminalExitCodes\": null\n    },\n    \"dataReferences\": {},\n    \"data\": {},\n    \"datacaches\": [],\n    \"outputData\": {},\n    \"sourceDirectoryDataStore\": null,\n    \"amlcompute\": {\n        \"vmSize\": null,\n        \"vmPriority\": null,\n        \"retainCluster\": false,\n        \"name\": null,\n        \"clusterMaxNodeCount\": null\n    },\n    \"kubernetescompute\": {\n        \"instanceType\": null\n    },\n    \"credentialPassthrough\": false,\n    \"command\": \"\",\n    \"environmentVariables\": {},\n    \"applicationEndpoints\": {}\n}"
          },
          "metadata": {}
        }
      ],
      "execution_count": 11,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "Define Environment"
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "# from azureml.core.conda_dependencies import CondaDependencies\n",
        "\n",
        "# dependencies = CondaDependencies()\n",
        "# dependencies.add_pip_package(\"scikit-learn\")\n",
        "# dependencies.add_pip_package(\"numpy==1.15.4\")\n",
        "\n",
        "# compute_config.environment.python.conda_dependencies = dependencies\n",
        "compute_config.environment = myenv"
      ],
      "outputs": [],
      "execution_count": 12,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "%%writefile ./source/train/train.py\n",
        "from sklearn import svm\n",
        "import numpy as np\n",
        "import joblib\n",
        "import os\n",
        "\n",
        "# customer ages\n",
        "X_train = np.array([50, 17, 35, 23, 28, 40, 31, 29, 19, 62])\n",
        "X_train = X_train.reshape(-1, 1)\n",
        "# churn y/n\n",
        "y_train = [\"yes\", \"no\", \"no\", \"no\", \"yes\", \"yes\", \"yes\", \"no\", \"no\", \"yes\"]\n",
        "\n",
        "clf = svm.SVC(gamma=0.001, C=100.)\n",
        "clf.fit(X_train, y_train)\n",
        "\n",
        "os.makedirs(\"outputs\", exist_ok=True)\n",
        "joblib.dump(value=clf, filename=\"outputs/churn-model.pkl\")"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "Overwriting ./source/train/train.py\n"
        }
      ],
      "execution_count": 68,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "from azureml.core.experiment import Experiment\n",
        "from azureml.core import ScriptRunConfig\n",
        "\n",
        "script_run_config = ScriptRunConfig(\n",
        "    source_directory=\"./source/train\",\n",
        "    script=\"train.py\",\n",
        "    run_config=compute_config)\n",
        "\n",
        "experiment = Experiment(workspace=ws, name=expName)\n",
        "\n",
        "run = experiment.submit(config=script_run_config)\n",
        "\n",
        "# This may take around 7 minutes\n",
        "run.wait_for_completion(show_output=True)"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "RunId: mtc-aml-lab-exp_1646127808_cca6ccee\nWeb View: https://ml.azure.com/runs/mtc-aml-lab-exp_1646127808_cca6ccee?wsid=/subscriptions/89da9f33-fd31-4ece-861e-5fab7af4dc11/resourcegroups/mtcs-dev-aml-rg/workspaces/mtcs-dev-aml&tid=72f988bf-86f1-41af-91ab-2d7cd011db47\n\nStreaming azureml-logs/20_image_build_log.txt\n=============================================\n\n2022/03/01 09:43:32 Downloading source code...\n2022/03/01 09:43:33 Finished downloading source code\n2022/03/01 09:43:33 Creating Docker network: acb_default_network, driver: 'bridge'\n2022/03/01 09:43:34 Successfully set up Docker network: acb_default_network\n2022/03/01 09:43:34 Setting up Docker configuration...\n2022/03/01 09:43:34 Successfully set up Docker configuration\n2022/03/01 09:43:34 Logging in to registry: mtcsdevamlcr.azurecr.io\n2022/03/01 09:43:35 Successfully logged into mtcsdevamlcr.azurecr.io\n2022/03/01 09:43:35 Executing step ID: acb_step_0. Timeout(sec): 5400, Working directory: '', Network: 'acb_default_network'\n2022/03/01 09:43:35 Scanning for dependencies...\n2022/03/01 09:43:35 Successfully scanned dependencies\n2022/03/01 09:43:35 Launching container with name: acb_step_0\nSending build context to Docker daemon  66.56kB\n\nStep 1/21 : FROM mcr.microsoft.com/azureml/openmpi3.1.2-ubuntu18.04:20211124.v1@sha256:4a11079816df82134801c513f323799acad2cbef525ef7a5361278d9b74b1d14\nmcr.microsoft.com/azureml/openmpi3.1.2-ubuntu18.04:20211124.v1@sha256:4a11079816df82134801c513f323799acad2cbef525ef7a5361278d9b74b1d14: Pulling from azureml/openmpi3.1.2-ubuntu18.04\n284055322776: Pulling fs layer\n56c2761c3a56: Pulling fs layer\ne7dff8330ff9: Pulling fs layer\nc782690959f6: Pulling fs layer\n722c34119f7e: Pulling fs layer\n2df507734fe8: Pulling fs layer\n858f3d745b66: Pulling fs layer\n7c1ed34d7266: Pulling fs layer\n1ef5f8a4fad5: Pulling fs layer\nc782690959f6: Waiting\n722c34119f7e: Waiting\n2df507734fe8: Waiting\n858f3d745b66: Waiting\n7c1ed34d7266: Waiting\n1ef5f8a4fad5: Waiting\n284055322776: Verifying Checksum\n284055322776: Download complete\nc782690959f6: Verifying Checksum\nc782690959f6: Download complete\n722c34119f7e: Verifying Checksum\n722c34119f7e: Download complete\n2df507734fe8: Verifying Checksum\n2df507734fe8: Download complete\ne7dff8330ff9: Verifying Checksum\ne7dff8330ff9: Download complete\n7c1ed34d7266: Verifying Checksum\n7c1ed34d7266: Download complete\n858f3d745b66: Verifying Checksum\n858f3d745b66: Download complete\n284055322776: Pull complete\n1ef5f8a4fad5: Download complete\n56c2761c3a56: Verifying Checksum\n56c2761c3a56: Download complete\n56c2761c3a56: Pull complete\ne7dff8330ff9: Pull complete\nc782690959f6: Pull complete\n722c34119f7e: Pull complete\n2df507734fe8: Pull complete\n858f3d745b66: Pull complete\n7c1ed34d7266: Pull complete\n1ef5f8a4fad5: Pull complete\nDigest: sha256:4a11079816df82134801c513f323799acad2cbef525ef7a5361278d9b74b1d14\nStatus: Downloaded newer image for mcr.microsoft.com/azureml/openmpi3.1.2-ubuntu18.04:20211124.v1@sha256:4a11079816df82134801c513f323799acad2cbef525ef7a5361278d9b74b1d14\n ---> 332d3aa8a60a\nStep 2/21 : USER root\n ---> Running in 7183741c8140\nRemoving intermediate container 7183741c8140\n ---> 171c72312a13\nStep 3/21 : RUN mkdir -p $HOME/.cache\n ---> Running in 38fff3dbb5eb\nRemoving intermediate container 38fff3dbb5eb\n ---> ccf315d962ff\nStep 4/21 : WORKDIR /\n ---> Running in c07237923095\nRemoving intermediate container c07237923095\n ---> 038dbfa28b08\nStep 5/21 : COPY azureml-environment-setup/99brokenproxy /etc/apt/apt.conf.d/\n ---> e261ad649089\nStep 6/21 : RUN if dpkg --compare-versions `conda --version | grep -oE '[^ ]+$'` lt 4.4.11; then conda install conda==4.4.11; fi\n ---> Running in 149c797ab081\nRemoving intermediate container 149c797ab081\n ---> b2d555b6f5ff\nStep 7/21 : COPY azureml-environment-setup/mutated_conda_dependencies.yml azureml-environment-setup/mutated_conda_dependencies.yml\n ---> 8ad9b8d854c3\nStep 8/21 : RUN ldconfig /usr/local/cuda/lib64/stubs && conda env create -p /azureml-envs/azureml_919bc46b07c95161e32444ce80d6d83c -f azureml-environment-setup/mutated_conda_dependencies.yml && rm -rf \"$HOME/.cache/pip\" && conda clean -aqy && CONDA_ROOT_DIR=$(conda info --root) && rm -rf \"$CONDA_ROOT_DIR/pkgs\" && find \"$CONDA_ROOT_DIR\" -type d -name __pycache__ -exec rm -rf {} + && ldconfig\n ---> Running in a19fcc261881\nWarning: you have pip-installed dependencies in your environment file, but you do not list pip itself as one of your conda dependencies.  Conda may not use the correct pip to install your packages, and they may end up in the wrong place.  Please add an explicit pip dependency.  I'm adding one for you, but still nagging you.\nCollecting package metadata (repodata.json): ...working... \ndone\nSolving environment: ...working... done\n\nDownloading and Extracting Packages\n\nlibblas-3.8.0        | 11 KB     |            |   0% \nlibblas-3.8.0        | 11 KB     | ########## | 100% \n\nlibstdcxx-ng-9.1.0   | 4.0 MB    |            |   0% \nlibstdcxx-ng-9.1.0   | 4.0 MB    | ########## | 100% \nlibstdcxx-ng-9.1.0   | 4.0 MB    | ########## | 100% \n\ntk-8.6.10            | 3.2 MB    |            |   0% \ntk-8.6.10            | 3.2 MB    | ########## | 100% \ntk-8.6.10            | 3.2 MB    | ########## | 100% \n\nsqlite-3.33.0        | 2.0 MB    |            |   0% \nsqlite-3.33.0        | 2.0 MB    | ########5  |  86% \nsqlite-3.33.0        | 2.0 MB    | ########## | 100% \n\nlibopenblas-0.3.10   | 7.8 MB    |            |   0% \nlibopenblas-0.3.10   | 7.8 MB    | ##2        |  22% \nlibopenblas-0.3.10   | 7.8 MB    | ########## | 100% \nlibopenblas-0.3.10   | 7.8 MB    | ########## | 100% \n\npython-3.6.12        | 34.0 MB   |            |   0% \npython-3.6.12        | 34.0 MB   | #          |  10% \npython-3.6.12        | 34.0 MB   | ###5       |  35% \npython-3.6.12        | 34.0 MB   | ######2    |  63% \npython-3.6.12        | 34.0 MB   | #######7   |  78% \npython-3.6.12        | 34.0 MB   | ########## | 100% \npython-3.6.12        | 34.0 MB   | ########## | 100% \n\nncurses-6.2          | 1.1 MB    |            |   0% \nncurses-6.2          | 1.1 MB    | ########## | 100% \nncurses-6.2          | 1.1 MB    | ########## | 100% \n\nld_impl_linux-64-2.3 | 645 KB    |            |   0% \nld_impl_linux-64-2.3 | 645 KB    | ########## | 100% \nld_impl_linux-64-2.3 | 645 KB    | ########## | 100% \n\nlibcblas-3.8.0       | 11 KB     |            |   0% \nlibcblas-3.8.0       | 11 KB     | ########## | 100% \n\nlibedit-3.1.20191231 | 121 KB    |            |   0% \nlibedit-3.1.20191231 | 121 KB    | ########## | 100% \n\nxz-5.2.5             | 438 KB    |            |   0% \nxz-5.2.5             | 438 KB    | ########## | 100% \nxz-5.2.5             | 438 KB    | ########## | 100% \n\nsetuptools-50.3.0    | 891 KB    |            |   0% \nsetuptools-50.3.0    | 891 KB    | ########## | 100% \nsetuptools-50.3.0    | 891 KB    | ########## | 100% \n\ncertifi-2020.6.20    | 160 KB    |            |   0% \ncertifi-2020.6.20    | 160 KB    | ########## | 100% \n\npip-20.2.4           | 2.0 MB    |            |   0% \npip-20.2.4           | 2.0 MB    | ########## | 100% \npip-20.2.4           | 2.0 MB    | ########## | 100% \n\nnumpy-1.17.0         | 5.2 MB    |            |   0% \nnumpy-1.17.0         | 5.2 MB    | ########## | 100% \nnumpy-1.17.0         | 5.2 MB    | ########## | 100% \n\nwheel-0.35.1         | 36 KB     |            |   0% \nwheel-0.35.1         | 36 KB     | ########## | 100% \n\nzlib-1.2.11          | 120 KB    |            |   0% \nzlib-1.2.11          | 120 KB    | ########## | 100% \n\nca-certificates-2020 | 128 KB    |            |   0% \nca-certificates-2020 | 128 KB    | ########## | 100% \n\nliblapack-3.8.0      | 11 KB     |            |   0% \nliblapack-3.8.0      | 11 KB     | ########## | 100% \n\nreadline-8.0         | 428 KB    |            |   0% \nreadline-8.0         | 428 KB    | ########## | 100% \nreadline-8.0         | 428 KB    | ########## | 100% \n\nlibffi-3.3           | 54 KB     |            |   0% \nlibffi-3.3           | 54 KB     | ########## | 100% \n\nopenssl-1.1.1h       | 3.8 MB    |            |   0% \nopenssl-1.1.1h       | 3.8 MB    | #########1 |  92% \nopenssl-1.1.1h       | 3.8 MB    | ########## | 100% \n\nlibgcc-ng-9.1.0      | 8.1 MB    |            |   0% \nlibgcc-ng-9.1.0      | 8.1 MB    | ########2  |  83% \nlibgcc-ng-9.1.0      | 8.1 MB    | ########## | 100% \n\nlibgfortran-ng-7.3.0 | 1.3 MB    |            |   0% \nlibgfortran-ng-7.3.0 | 1.3 MB    | ########## | 100% \nlibgfortran-ng-7.3.0 | 1.3 MB    | ########## | 100% \nPreparing transaction: ...working... done\nVerifying transaction: ...working... done\nExecuting transaction: ...working... done\nInstalling pip dependencies: ...working... \n"
        },
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "Ran pip subprocess with arguments:\n['/azureml-envs/azureml_919bc46b07c95161e32444ce80d6d83c/bin/python', '-m', 'pip', 'install', '-U', '-r', '/azureml-environment-setup/condaenv.gvosgg28.requirements.txt']\nPip subprocess output:\nCollecting azureml-defaults\n  Downloading azureml_defaults-1.39.0-py3-none-any.whl (3.0 kB)\nCollecting scikit-learn\n  Downloading scikit_learn-0.24.2-cp36-cp36m-manylinux2010_x86_64.whl (22.2 MB)\nCollecting pillow\n  Downloading Pillow-8.4.0-cp36-cp36m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (3.1 MB)\nCollecting azureml-core~=1.39.0\n  Downloading azureml_core-1.39.0-py3-none-any.whl (2.5 MB)\nCollecting azureml-inference-server-http~=0.4.1\n  Downloading azureml_inference_server_http-0.4.10-py3-none-any.whl (38 kB)\nCollecting azureml-dataset-runtime[fuse]~=1.39.0\n  Downloading azureml_dataset_runtime-1.39.0-py3-none-any.whl (3.5 kB)\nCollecting configparser==3.7.4\n  Downloading configparser-3.7.4-py2.py3-none-any.whl (22 kB)\nCollecting json-logging-py==0.2\n  Downloading json-logging-py-0.2.tar.gz (3.6 kB)\nRequirement already satisfied, skipping upgrade: numpy>=1.13.3 in /azureml-envs/azureml_919bc46b07c95161e32444ce80d6d83c/lib/python3.6/site-packages (from scikit-learn->-r /azureml-environment-setup/condaenv.gvosgg28.requirements.txt (line 2)) (1.17.0)\nCollecting threadpoolctl>=2.0.0\n  Downloading threadpoolctl-3.1.0-py3-none-any.whl (14 kB)\nCollecting joblib>=0.11\n  Downloading joblib-1.1.0-py2.py3-none-any.whl (306 kB)\nCollecting scipy>=0.19.1\n  Downloading scipy-1.5.4-cp36-cp36m-manylinux1_x86_64.whl (25.9 MB)\nCollecting paramiko<3.0.0,>=2.0.8\n  Downloading paramiko-2.9.2-py2.py3-none-any.whl (210 kB)\nCollecting msrestazure<=0.6.4,>=0.4.33\n  Downloading msrestazure-0.6.4-py2.py3-none-any.whl (40 kB)\nCollecting jsonpickle<3.0.0\n  Downloading jsonpickle-2.1.0-py2.py3-none-any.whl (38 kB)\nCollecting contextlib2<22.0.0\n  Downloading contextlib2-21.6.0-py2.py3-none-any.whl (13 kB)\nCollecting adal<=1.2.7,>=1.2.0\n  Downloading adal-1.2.7-py2.py3-none-any.whl (55 kB)\nCollecting msal<2.0.0,>=1.15.0\n  Downloading msal-1.17.0-py2.py3-none-any.whl (79 kB)\nCollecting backports.tempfile\n  Downloading backports.tempfile-1.0-py2.py3-none-any.whl (4.4 kB)\nCollecting jmespath<1.0.0\n  Downloading jmespath-0.10.0-py2.py3-none-any.whl (24 kB)\nCollecting azure-mgmt-containerregistry<9.0.0,>=8.2.0\n  Downloading azure_mgmt_containerregistry-8.2.0-py2.py3-none-any.whl (928 kB)\nCollecting msal-extensions<0.4,>=0.3.0\n  Downloading msal_extensions-0.3.1-py2.py3-none-any.whl (18 kB)\nCollecting azure-mgmt-keyvault<10.0.0,>=0.40.0\n  Downloading azure_mgmt_keyvault-9.3.0-py2.py3-none-any.whl (412 kB)\nCollecting azure-mgmt-storage<20.0.0,>=16.0.0\n  Downloading azure_mgmt_storage-19.1.0-py3-none-any.whl (1.8 MB)\nCollecting pkginfo\n  Downloading pkginfo-1.8.2-py2.py3-none-any.whl (26 kB)\nCollecting ndg-httpsclient<=0.5.1\n  Downloading ndg_httpsclient-0.5.1-py3-none-any.whl (34 kB)\nCollecting pyopenssl<22.0.0\n  Downloading pyOpenSSL-21.0.0-py2.py3-none-any.whl (55 kB)\nCollecting knack~=0.9.0\n  Downloading knack-0.9.0-py3-none-any.whl (59 kB)\nCollecting msrest<1.0.0,>=0.5.1\n  Downloading msrest-0.6.21-py2.py3-none-any.whl (85 kB)\nCollecting azure-core<1.22\n  Downloading azure_core-1.21.1-py2.py3-none-any.whl (178 kB)\nCollecting pytz\n  Downloading pytz-2021.3-py2.py3-none-any.whl (503 kB)\nCollecting urllib3<=1.26.7,>=1.23\n  Downloading urllib3-1.26.7-py2.py3-none-any.whl (138 kB)\nCollecting PyJWT<3.0.0\n  Downloading PyJWT-2.3.0-py3-none-any.whl (16 kB)\nCollecting azure-common<2.0.0,>=1.1.12\n  Downloading azure_common-1.1.28-py2.py3-none-any.whl (14 kB)\nCollecting argcomplete<2.0\n  Downloading argcomplete-1.12.3-py2.py3-none-any.whl (38 kB)\nCollecting docker<6.0.0\n  Downloading docker-5.0.3-py2.py3-none-any.whl (146 kB)\nCollecting requests[socks]<3.0.0,>=2.19.1\n  Downloading requests-2.27.1-py2.py3-none-any.whl (63 kB)\nCollecting azure-mgmt-authorization<1.0.0,>=0.40.0\n  Downloading azure_mgmt_authorization-0.61.0-py2.py3-none-any.whl (94 kB)\nCollecting azure-mgmt-resource<21.0.0,>=15.0.0\n  Downloading azure_mgmt_resource-20.1.0-py3-none-any.whl (2.3 MB)\nCollecting pathspec<1.0.0\n  Downloading pathspec-0.9.0-py2.py3-none-any.whl (31 kB)\nCollecting packaging<22.0,>=20.0\n  Downloading packaging-21.3-py3-none-any.whl (40 kB)\nCollecting cryptography!=1.9,!=2.0.*,!=2.1.*,!=2.2.*,<37.0.0\n  Downloading cryptography-36.0.1-cp36-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (3.8 MB)\nCollecting python-dateutil<3.0.0,>=2.7.3\n  Downloading python_dateutil-2.8.2-py2.py3-none-any.whl (247 kB)\nCollecting SecretStorage<4.0.0\n  Downloading SecretStorage-3.3.1-py3-none-any.whl (15 kB)\nCollecting azure-graphrbac<1.0.0,>=0.40.0\n  Downloading azure_graphrbac-0.61.1-py2.py3-none-any.whl (141 kB)\nCollecting humanfriendly<11.0,>=4.7\n  Downloading humanfriendly-10.0-py2.py3-none-any.whl (86 kB)\nCollecting inference-schema==1.3.0\n  Downloading inference_schema-1.3.0-py3-none-any.whl (19 kB)\nCollecting applicationinsights>=0.11.7\n  Downloading applicationinsights-0.11.10-py2.py3-none-any.whl (55 kB)\nCollecting itsdangerous<2.0,>=0.24\n  Downloading itsdangerous-1.1.0-py2.py3-none-any.whl (16 kB)\nCollecting gunicorn==20.1.0; platform_system != \"Windows\"\n  Downloading gunicorn-20.1.0-py3-none-any.whl (79 kB)\nCollecting flask==1.0.3\n  Downloading Flask-1.0.3-py2.py3-none-any.whl (92 kB)\nCollecting azureml-dataprep<2.28.0a,>=2.27.1a\n  Downloading azureml_dataprep-2.27.1-py3-none-any.whl (39.4 MB)\nCollecting pyarrow<4.0.0,>=0.17.0\n  Downloading pyarrow-3.0.0-cp36-cp36m-manylinux2014_x86_64.whl (20.7 MB)\nCollecting fusepy<4.0.0,>=3.0.1; extra == \"fuse\"\n  Downloading fusepy-3.0.1.tar.gz (11 kB)\nCollecting pynacl>=1.0.1\n  Downloading PyNaCl-1.5.0-cp36-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.manylinux_2_24_x86_64.whl (856 kB)\nCollecting bcrypt>=3.1.3\n  Downloading bcrypt-3.2.0-cp36-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.manylinux_2_24_x86_64.whl (61 kB)\nCollecting six\n  Downloading six-1.16.0-py2.py3-none-any.whl (11 kB)\nCollecting importlib-metadata; python_version < \"3.8\"\n  Downloading importlib_metadata-4.8.3-py3-none-any.whl (17 kB)\nCollecting backports.weakref\n  Downloading backports.weakref-1.0.post1-py2.py3-none-any.whl (5.2 kB)\nCollecting azure-mgmt-core<2.0.0,>=1.2.0\n  Downloading azure_mgmt_core-1.3.0-py2.py3-none-any.whl (25 kB)\nCollecting portalocker<3,>=1.0; python_version >= \"3.5\" and platform_system != \"Windows\"\n  Downloading portalocker-2.4.0-py2.py3-none-any.whl (16 kB)\nCollecting pyasn1>=0.1.1\n  Downloading pyasn1-0.4.8-py2.py3-none-any.whl (77 kB)\nCollecting pygments\n  Downloading Pygments-2.11.2-py3-none-any.whl (1.1 MB)\nCollecting pyyaml\n  Downloading PyYAML-6.0-cp36-cp36m-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_12_x86_64.manylinux2010_x86_64.whl (603 kB)\nCollecting tabulate\n  Downloading tabulate-0.8.9-py3-none-any.whl (25 kB)\nCollecting isodate>=0.6.0\n  Downloading isodate-0.6.1-py2.py3-none-any.whl (41 kB)\nCollecting requests-oauthlib>=0.5.0\n  Downloading requests_oauthlib-1.3.1-py2.py3-none-any.whl (23 kB)\nRequirement already satisfied, skipping upgrade: certifi>=2017.4.17 in /azureml-envs/azureml_919bc46b07c95161e32444ce80d6d83c/lib/python3.6/site-packages (from msrest<1.0.0,>=0.5.1->azureml-core~=1.39.0->azureml-defaults->-r /azureml-environment-setup/condaenv.gvosgg28.requirements.txt (line 1)) (2020.6.20)\nCollecting websocket-client>=0.32.0\n  Downloading websocket_client-1.3.1-py3-none-any.whl (54 kB)\nCollecting charset-normalizer~=2.0.0; python_version >= \"3\"\n  Downloading charset_normalizer-2.0.12-py3-none-any.whl (39 kB)\nCollecting idna<4,>=2.5; python_version >= \"3\"\n  Downloading idna-3.3-py3-none-any.whl (61 kB)\nCollecting PySocks!=1.5.7,>=1.5.6; extra == \"socks\"\n  Downloading PySocks-1.7.1-py3-none-any.whl (16 kB)\nCollecting pyparsing!=3.0.5,>=2.0.2\n  Downloading pyparsing-3.0.7-py3-none-any.whl (98 kB)\nCollecting cffi>=1.12\n  Downloading cffi-1.15.0-cp36-cp36m-manylinux_2_5_x86_64.manylinux1_x86_64.whl (405 kB)\nCollecting jeepney>=0.6\n  Downloading jeepney-0.7.1-py3-none-any.whl (54 kB)\nCollecting wrapt<=1.12.1,>=1.11.1\n  Downloading wrapt-1.12.1.tar.gz (27 kB)\nRequirement already satisfied, skipping upgrade: setuptools>=3.0 in /azureml-envs/azureml_919bc46b07c95161e32444ce80d6d83c/lib/python3.6/site-packages (from gunicorn==20.1.0; platform_system != \"Windows\"->azureml-inference-server-http~=0.4.1->azureml-defaults->-r /azureml-environment-setup/condaenv.gvosgg28.requirements.txt (line 1)) (50.3.0.post20201006)\nCollecting click>=5.1\n  Downloading click-8.0.4-py3-none-any.whl (97 kB)\nCollecting Jinja2>=2.10\n  Downloading Jinja2-3.0.3-py3-none-any.whl (133 kB)\nCollecting Werkzeug>=0.14\n  Downloading Werkzeug-2.0.3-py3-none-any.whl (289 kB)\nCollecting cloudpickle<3.0.0,>=1.1.0\n  Downloading cloudpickle-2.0.0-py3-none-any.whl (25 kB)\nCollecting dotnetcore2<3.0.0,>=2.1.14\n  Downloading dotnetcore2-2.1.23-py3-none-manylinux1_x86_64.whl (29.3 MB)\nCollecting azureml-dataprep-native<39.0.0,>=38.0.0\n  Downloading azureml_dataprep_native-38.0.0-cp36-cp36m-manylinux1_x86_64.whl (1.3 MB)\nCollecting azureml-dataprep-rslex~=2.3.0dev0\n  Downloading azureml_dataprep_rslex-2.3.1-cp36-cp36m-manylinux1_x86_64.whl (13.6 MB)\nCollecting azure-identity==1.7.0\n  Downloading azure_identity-1.7.0-py2.py3-none-any.whl (129 kB)\nCollecting zipp>=0.5\n  Downloading zipp-3.6.0-py3-none-any.whl (5.3 kB)\nCollecting typing-extensions>=3.6.4; python_version < \"3.8\"\n  Downloading typing_extensions-4.1.1-py3-none-any.whl (26 kB)\nCollecting oauthlib>=3.0.0\n  Downloading oauthlib-3.2.0-py3-none-any.whl (151 kB)\nCollecting pycparser\n  Downloading pycparser-2.21-py2.py3-none-any.whl (118 kB)\nCollecting MarkupSafe>=2.0\n  Downloading MarkupSafe-2.0.1-cp36-cp36m-manylinux2010_x86_64.whl (30 kB)\nCollecting dataclasses; python_version < \"3.7\"\n  Downloading dataclasses-0.8-py3-none-any.whl (19 kB)\nCollecting distro>=1.2.0\n  Downloading distro-1.7.0-py3-none-any.whl (20 kB)\nBuilding wheels for collected packages: json-logging-py, fusepy, wrapt\n  Building wheel for json-logging-py (setup.py): started\n  Building wheel for json-logging-py (setup.py): finished with status 'done'\n  Created wheel for json-logging-py: filename=json_logging_py-0.2-py3-none-any.whl size=3924 sha256=051d191a3201a7e1a44fc7ba0545f1f66406ccd80fbcff73f2753226b3191b0f\n  Stored in directory: /root/.cache/pip/wheels/e2/1d/52/535a274b9c2ce7d4064838f2bdb62013801281ef7d7f21e2ee\n  Building wheel for fusepy (setup.py): started\n  Building wheel for fusepy (setup.py): finished with status 'done'\n  Created wheel for fusepy: filename=fusepy-3.0.1-py3-none-any.whl size=10504 sha256=7bc12539f5bfef5a5140d81bc7b152ad07b877a4de4f2f2ba82f574f11e69657\n  Stored in directory: /root/.cache/pip/wheels/21/5c/83/1dd7e8a232d12227e5410120f4374b33adeb4037473105b079\n  Building wheel for wrapt (setup.py): started\n  Building wheel for wrapt (setup.py): finished with status 'done'\n  Created wheel for wrapt: filename=wrapt-1.12.1-cp36-cp36m-linux_x86_64.whl size=69788 sha256=cd9dad11b8eb8333a414ee88d38a6773562595c1b50887deb0e7e0c7c127d66a\n  Stored in directory: /root/.cache/pip/wheels/32/42/7f/23cae9ff6ef66798d00dc5d659088e57dbba01566f6c60db63\nSuccessfully built json-logging-py fusepy wrapt\nInstalling collected packages: pycparser, cffi, pynacl, six, bcrypt, cryptography, paramiko, charset-normalizer, urllib3, idna, PySocks, requests, python-dateutil, PyJWT, adal, isodate, oauthlib, requests-oauthlib, msrest, msrestazure, zipp, typing-extensions, importlib-metadata, jsonpickle, contextlib2, msal, backports.weakref, backports.tempfile, jmespath, azure-core, azure-mgmt-core, azure-common, azure-mgmt-containerregistry, portalocker, msal-extensions, azure-mgmt-keyvault, azure-mgmt-storage, pkginfo, pyasn1, pyopenssl, ndg-httpsclient, argcomplete, pygments, pyyaml, tabulate, knack, pytz, websocket-client, docker, azure-mgmt-authorization, azure-mgmt-resource, pathspec, pyparsing, packaging, jeepney, SecretStorage, azure-graphrbac, humanfriendly, azureml-core, wrapt, inference-schema, applicationinsights, itsdangerous, gunicorn, click, MarkupSafe, Jinja2, dataclasses, Werkzeug, flask, azureml-inference-server-http, cloudpickle, distro, dotnetcore2, azureml-dataprep-native, azureml-dataprep-rslex, azure-identity, azureml-dataprep, pyarrow, fusepy, azureml-dataset-runtime, configparser, json-logging-py, azureml-defaults, threadpoolctl, joblib, scipy, scikit-learn, pillow\nSuccessfully installed Jinja2-3.0.3 MarkupSafe-2.0.1 PyJWT-2.3.0 PySocks-1.7.1 SecretStorage-3.3.1 Werkzeug-2.0.3 adal-1.2.7 applicationinsights-0.11.10 argcomplete-1.12.3 azure-common-1.1.28 azure-core-1.21.1 azure-graphrbac-0.61.1 azure-identity-1.7.0 azure-mgmt-authorization-0.61.0 azure-mgmt-containerregistry-8.2.0 azure-mgmt-core-1.3.0 azure-mgmt-keyvault-9.3.0 azure-mgmt-resource-20.1.0 azure-mgmt-storage-19.1.0 azureml-core-1.39.0 azureml-dataprep-2.27.1 azureml-dataprep-native-38.0.0 azureml-dataprep-rslex-2.3.1 azureml-dataset-runtime-1.39.0 azureml-defaults-1.39.0 azureml-inference-server-http-0.4.10 backports.tempfile-1.0 backports.weakref-1.0.post1 bcrypt-3.2.0 cffi-1.15.0 charset-normalizer-2.0.12 click-8.0.4 cloudpickle-2.0.0 configparser-3.7.4 contextlib2-21.6.0 cryptography-36.0.1 dataclasses-0.8 distro-1.7.0 docker-5.0.3 dotnetcore2-2.1.23 flask-1.0.3 fusepy-3.0.1 gunicorn-20.1.0 humanfriendly-10.0 idna-3.3 importlib-metadata-4.8.3 inference-schema-1.3.0 isodate-0.6.1 itsdangerous-1.1.0 jeepney-0.7.1 jmespath-0.10.0 joblib-1.1.0 json-logging-py-0.2 jsonpickle-2.1.0 knack-0.9.0 msal-1.17.0 msal-extensions-0.3.1 msrest-0.6.21 msrestazure-0.6.4 ndg-httpsclient-0.5.1 oauthlib-3.2.0 packaging-21.3 paramiko-2.9.2 pathspec-0.9.0 pillow-8.4.0 pkginfo-1.8.2 portalocker-2.4.0 pyarrow-3.0.0 pyasn1-0.4.8 pycparser-2.21 pygments-2.11.2 pynacl-1.5.0 pyopenssl-21.0.0 pyparsing-3.0.7 python-dateutil-2.8.2 pytz-2021.3 pyyaml-6.0 requests-2.27.1 requests-oauthlib-1.3.1 scikit-learn-0.24.2 scipy-1.5.4 six-1.16.0 tabulate-0.8.9 threadpoolctl-3.1.0 typing-extensions-4.1.1 urllib3-1.26.7 websocket-client-1.3.1 wrapt-1.12.1 zipp-3.6.0\n\ndone\n#\n# To activate this environment, use\n#\n#     $ conda activate /azureml-envs/azureml_919bc46b07c95161e32444ce80d6d83c\n#\n# To deactivate an active environment, use\n#\n#     $ conda deactivate\n\n\u001b[91m\n\n==> WARNING: A newer version of conda exists. <==\n  current version: 4.9.2\n  latest version: 4.11.0\n\nPlease update conda by running\n\n    $ conda update -n base -c defaults conda\n\n\n\u001b[0mWARNING: /root/.conda/pkgs does not exist\nRemoving intermediate container a19fcc261881\n ---> a968f0ab4250\nStep 9/21 : ENV PATH /azureml-envs/azureml_919bc46b07c95161e32444ce80d6d83c/bin:$PATH\n ---> Running in ee470801de59\nRemoving intermediate container ee470801de59\n ---> 7b845ce7abb8\nStep 10/21 : COPY azureml-environment-setup/send_conda_dependencies.py azureml-environment-setup/send_conda_dependencies.py\n ---> 793cd2ba4b34\nStep 11/21 : RUN echo \"Copying environment context\"\n ---> Running in bad89271b774\nCopying environment context\nRemoving intermediate container bad89271b774\n ---> e9068cd04f3a\nStep 12/21 : COPY azureml-environment-setup/environment_context.json azureml-environment-setup/environment_context.json\n ---> 43f9e5a1e004\nStep 13/21 : RUN python /azureml-environment-setup/send_conda_dependencies.py -p /azureml-envs/azureml_919bc46b07c95161e32444ce80d6d83c\n ---> Running in 19077758a37a\nReport materialized dependencies for the environment\nReading environment context\nExporting conda environment\nSending request with materialized conda environment details\nSuccessfully sent materialized environment details\nRemoving intermediate container 19077758a37a\n ---> 0247dbc97cbc\nStep 14/21 : ENV AZUREML_CONDA_ENVIRONMENT_PATH /azureml-envs/azureml_919bc46b07c95161e32444ce80d6d83c\n ---> Running in f3e3a4ee9c8a\nRemoving intermediate container f3e3a4ee9c8a\n ---> 4e1a2a086e14\nStep 15/21 : ENV LD_LIBRARY_PATH /azureml-envs/azureml_919bc46b07c95161e32444ce80d6d83c/lib:$LD_LIBRARY_PATH\n ---> Running in 3f9711e34a70\nRemoving intermediate container 3f9711e34a70\n ---> 7a42ae89707b\nStep 16/21 : ENV CONDA_DEFAULT_ENV=azureml_919bc46b07c95161e32444ce80d6d83c CONDA_PREFIX=/azureml-envs/azureml_919bc46b07c95161e32444ce80d6d83c\n ---> Running in 8d858a590953\nRemoving intermediate container 8d858a590953\n ---> 0728208f8db2\nStep 17/21 : COPY azureml-environment-setup/spark_cache.py azureml-environment-setup/log4j.properties /azureml-environment-setup/\n ---> 330b099b15ed\nStep 18/21 : RUN if [ $SPARK_HOME ]; then /bin/bash -c '$SPARK_HOME/bin/spark-submit  /azureml-environment-setup/spark_cache.py'; fi\n"
        },
        {
          "output_type": "stream",
          "name": "stdout",
          "text": " ---> Running in 4924a806fa66\nRemoving intermediate container 4924a806fa66\n ---> 15382aa967c9\nStep 19/21 : RUN rm -rf azureml-environment-setup\n ---> Running in 05c8e245bf27\nRemoving intermediate container 05c8e245bf27\n ---> 1355185a9e54\nStep 20/21 : ENV AZUREML_ENVIRONMENT_IMAGE True\n ---> Running in b5e0e4391028\nRemoving intermediate container b5e0e4391028\n ---> efdbc096b4cd\nStep 21/21 : CMD [\"bash\"]\n ---> Running in daa95f0da2cf\nRemoving intermediate container daa95f0da2cf\n ---> fb5eaccbc3d7\nSuccessfully built fb5eaccbc3d7\nSuccessfully tagged mtcsdevamlcr.azurecr.io/azureml/azureml_a2297523ba63ca9bf5eeed281421a16a:latest\nSuccessfully tagged mtcsdevamlcr.azurecr.io/azureml/azureml_a2297523ba63ca9bf5eeed281421a16a:1\n2022/03/01 09:46:25 Successfully executed container: acb_step_0\n2022/03/01 09:46:25 Executing step ID: acb_step_1. Timeout(sec): 5400, Working directory: '', Network: 'acb_default_network'\n2022/03/01 09:46:25 Pushing image: mtcsdevamlcr.azurecr.io/azureml/azureml_a2297523ba63ca9bf5eeed281421a16a:1, attempt 1\nThe push refers to repository [mtcsdevamlcr.azurecr.io/azureml/azureml_a2297523ba63ca9bf5eeed281421a16a]\n99f8cc4da13f: Preparing\n5522c387a534: Preparing\nf5035f515fd9: Preparing\nca37abe89d25: Preparing\nb45a9a184b32: Preparing\n1b4f30a7b606: Preparing\n74e042dbc55e: Preparing\n649e018587de: Preparing\n1979b4c2d762: Preparing\nfcb1f3fd8c91: Preparing\n3c50432f3f31: Preparing\n311c5d6a5fbd: Preparing\n510d9bebb038: Preparing\nae7a6b62e247: Preparing\n98fed88a80e7: Preparing\ne2015ea1a701: Preparing\nf7df5bbbf80f: Preparing\n17773ff7b0e9: Preparing\n824bf068fd3d: Preparing\nfcb1f3fd8c91: Waiting\n3c50432f3f31: Waiting\n311c5d6a5fbd: Waiting\n510d9bebb038: Waiting\nae7a6b62e247: Waiting\n98fed88a80e7: Waiting\ne2015ea1a701: Waiting\nf7df5bbbf80f: Waiting\n17773ff7b0e9: Waiting\n824bf068fd3d: Waiting\n1b4f30a7b606: Waiting\n74e042dbc55e: Waiting\n1979b4c2d762: Waiting\n649e018587de: Waiting\nca37abe89d25: Pushed\n5522c387a534: Pushed\nb45a9a184b32: Pushed\n99f8cc4da13f: Pushed\nf5035f515fd9: Pushed\n74e042dbc55e: Pushed\n649e018587de: Pushed\n1979b4c2d762: Pushed\nfcb1f3fd8c91: Pushed\n3c50432f3f31: Pushed\n311c5d6a5fbd: Pushed\n510d9bebb038: Pushed\nae7a6b62e247: Pushed\n\nf7df5bbbf80f: Pushed\ne2015ea1a701: Pushed\n98fed88a80e7: Pushed\n824bf068fd3d: Pushed\n17773ff7b0e9: Pushed\n\nStreaming azureml-logs/55_azureml-execution-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt\n========================================================================================================================\n\n2022-03-01T09:47:54Z Running following command: /bin/bash -c sudo blobfuse /mnt/batch/tasks/shared/LS_root/jobs/mtcs-dev-aml/azureml/mtc-aml-lab-exp_1646127808_cca6ccee/mounts/workspaceblobstore --tmp-path=/mnt/batch/tasks/shared/LS_root/jobs/mtcs-dev-aml/azureml/mtc-aml-lab-exp_1646127808_cca6ccee/caches/workspaceblobstore -o ro --file-cache-timeout-in-seconds=1000000 --cache-size-mb=10742 -o nonempty -o allow_other --config-file=/mnt/batch/tasks/shared/LS_root/jobs/mtcs-dev-aml/azureml/mtc-aml-lab-exp_1646127808_cca6ccee/configs/workspaceblobstore.cfg --log-level=LOG_WARNING\n2022-03-01T09:47:54Z Successfully mounted a/an Blobfuse File System at /mnt/batch/tasks/shared/LS_root/jobs/mtcs-dev-aml/azureml/mtc-aml-lab-exp_1646127808_cca6ccee/mounts/workspaceblobstore -- stdout/stderr: \n2022-03-01T09:47:54Z The vmsize standard_ds3_v2 is not a GPU VM, skipping get GPU count by running nvidia-smi command.\n2022-03-01T09:47:54Z Starting output-watcher...\n2022-03-01T09:47:54Z IsDedicatedCompute == True, won't poll for Low Pri Preemption\n2022-03-01T09:47:54Z Executing 'Copy ACR Details file' on 10.1.0.5\n2022-03-01T09:47:54Z Copy ACR Details file succeeded on 10.1.0.5. Output: \n>>>   \n>>>   \nLogin Succeeded\nUsing default tag: latest\nlatest: Pulling from azureml/azureml_a2297523ba63ca9bf5eeed281421a16a\n284055322776: Already exists\n56c2761c3a56: Already exists\ne7dff8330ff9: Already exists\nc782690959f6: Already exists\n722c34119f7e: Already exists\n2df507734fe8: Already exists\n858f3d745b66: Already exists\n7c1ed34d7266: Already exists\n1ef5f8a4fad5: Already exists\n6c628f81c421: Pulling fs layer\n83ec4584bd4a: Pulling fs layer\nb4f5779a5602: Pulling fs layer\na139f13326c2: Pulling fs layer\nb97e3527ae26: Pulling fs layer\ne4f26175b4a3: Pulling fs layer\nc73d33a145d0: Pulling fs layer\na139f13326c2: Waiting\ne4f26175b4a3: Waiting\n334caeebc691: Pulling fs layer\nf0c40ba74bd5: Pulling fs layer\n3f3178488a18: Pulling fs layer\nc73d33a145d0: Waiting\n3f3178488a18: Waiting\n334caeebc691: Waiting\nf0c40ba74bd5: Waiting\n6c628f81c421: Verifying Checksum\n83ec4584bd4a: Verifying Checksum\n83ec4584bd4a: Download complete\na139f13326c2: Verifying Checksum\na139f13326c2: Download complete\nb4f5779a5602: Download complete\ne4f26175b4a3: Verifying Checksum\ne4f26175b4a3: Download complete\nc73d33a145d0: Download complete\n334caeebc691: Download complete\n3f3178488a18: Verifying Checksum\n3f3178488a18: Download complete\nf0c40ba74bd5: Verifying Checksum\nf0c40ba74bd5: Download complete\n6c628f81c421: Pull complete\n83ec4584bd4a: Pull complete\nb4f5779a5602: Pull complete\na139f13326c2: Pull complete\nb97e3527ae26: Verifying Checksum\nb97e3527ae26: Download complete\n\nStreaming azureml-logs/75_job_post-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt\n===============================================================================================================\n\n[2022-03-01T09:48:27.239505] Entering job release\n[2022-03-01T09:48:28.403426] Starting job release\n[2022-03-01T09:48:28.404130] Logging experiment finalizing status in history service.\nStarting the daemon thread to refresh tokens in background for process with pid = 124\n[2022-03-01T09:48:28.404495] job release stage : upload_datastore starting...\n[2022-03-01T09:48:28.405152] job release stage : start importing azureml.history._tracking in run_history_release.\n[2022-03-01T09:48:28.405986] job release stage : copy_batchai_cached_logs starting...\n[2022-03-01T09:48:28.406032] job release stage : execute_job_release starting...\n[2022-03-01T09:48:28.406352] Entering context manager injector.\n[2022-03-01T09:48:28.406404] job release stage : copy_batchai_cached_logs completed...\n[2022-03-01T09:48:28.419673] job release stage : upload_datastore completed...\n[2022-03-01T09:48:28.522491] job release stage : send_run_telemetry starting...\n[2022-03-01T09:48:28.556162] get vm size and vm region successfully.\n[2022-03-01T09:48:28.581475] get compute meta data successfully.\n[2022-03-01T09:48:28.667941] job release stage : execute_job_release completed...\n[2022-03-01T09:48:28.747407] post artifact meta request successfully.\n[2022-03-01T09:48:28.789103] upload compute record artifact successfully.\n[2022-03-01T09:48:28.789223] job release stage : send_run_telemetry completed...\n[2022-03-01T09:48:28.789442] Job release is complete\n\nExecution Summary\n=================\nRunId: mtc-aml-lab-exp_1646127808_cca6ccee\nWeb View: https://ml.azure.com/runs/mtc-aml-lab-exp_1646127808_cca6ccee?wsid=/subscriptions/89da9f33-fd31-4ece-861e-5fab7af4dc11/resourcegroups/mtcs-dev-aml-rg/workspaces/mtcs-dev-aml&tid=72f988bf-86f1-41af-91ab-2d7cd011db47\n\n"
        },
        {
          "output_type": "execute_result",
          "execution_count": 13,
          "data": {
            "text/plain": "{'runId': 'mtc-aml-lab-exp_1646127808_cca6ccee',\n 'target': 'hyssh1',\n 'status': 'Completed',\n 'startTimeUtc': '2022-03-01T09:47:53.377109Z',\n 'endTimeUtc': '2022-03-01T09:48:38.611061Z',\n 'services': {},\n 'properties': {'_azureml.ComputeTargetType': 'amlcompute',\n  'ContentSnapshotId': '07e79727-d135-4b40-934b-67523cae3ea3',\n  'azureml.git.repository_uri': 'https://github.com/hyssh/mtc-open-workshop.git',\n  'mlflow.source.git.repoURL': 'https://github.com/hyssh/mtc-open-workshop.git',\n  'azureml.git.branch': 'master',\n  'mlflow.source.git.branch': 'master',\n  'azureml.git.commit': '971b75559670c5ff8880ddd2b70372227a814603',\n  'mlflow.source.git.commit': '971b75559670c5ff8880ddd2b70372227a814603',\n  'azureml.git.dirty': 'True',\n  'ProcessInfoFile': 'azureml-logs/process_info.json',\n  'ProcessStatusFile': 'azureml-logs/process_status.json'},\n 'inputDatasets': [],\n 'outputDatasets': [],\n 'runDefinition': {'script': 'train.py',\n  'command': '',\n  'useAbsolutePath': False,\n  'arguments': [],\n  'sourceDirectoryDataStore': None,\n  'framework': 'Python',\n  'communicator': 'None',\n  'target': 'hyssh1',\n  'dataReferences': {},\n  'data': {},\n  'outputData': {},\n  'datacaches': [],\n  'jobName': None,\n  'maxRunDurationSeconds': None,\n  'nodeCount': 1,\n  'instanceTypes': [],\n  'priority': None,\n  'credentialPassthrough': False,\n  'identity': None,\n  'environment': {'name': 'myEnv',\n   'version': '5',\n   'python': {'interpreterPath': 'python',\n    'userManagedDependencies': False,\n    'condaDependencies': {'channels': ['anaconda', 'conda-forge'],\n     'dependencies': ['python=3.6',\n      {'pip': ['azureml-defaults', 'scikit-learn', 'pillow']},\n      'numpy==1.17.0'],\n     'name': 'azureml_919bc46b07c95161e32444ce80d6d83c'},\n    'baseCondaEnvironment': None},\n   'environmentVariables': {'EXAMPLE_ENV_VAR': 'EXAMPLE_VALUE'},\n   'docker': {'baseImage': 'mcr.microsoft.com/azureml/openmpi3.1.2-ubuntu18.04:20211124.v1',\n    'platform': {'os': 'Linux', 'architecture': 'amd64'},\n    'baseDockerfile': None,\n    'baseImageRegistry': {'address': None, 'username': None, 'password': None},\n    'enabled': False,\n    'arguments': []},\n   'spark': {'repositories': [], 'packages': [], 'precachePackages': True},\n   'inferencingStackVersion': None},\n  'history': {'outputCollection': True,\n   'directoriesToWatch': ['logs'],\n   'enableMLflowTracking': True,\n   'snapshotProject': True},\n  'spark': {'configuration': {'spark.app.name': 'Azure ML Experiment',\n    'spark.yarn.maxAppAttempts': '1'}},\n  'parallelTask': {'maxRetriesPerWorker': 0,\n   'workerCountPerNode': 1,\n   'terminalExitCodes': None,\n   'configuration': {}},\n  'amlCompute': {'name': None,\n   'vmSize': None,\n   'retainCluster': False,\n   'clusterMaxNodeCount': None},\n  'aiSuperComputer': {'instanceType': 'D2',\n   'imageVersion': 'pytorch-1.7.0',\n   'location': None,\n   'aiSuperComputerStorageData': None,\n   'interactive': False,\n   'scalePolicy': None,\n   'virtualClusterArmId': None,\n   'tensorboardLogDirectory': None,\n   'sshPublicKey': None,\n   'sshPublicKeys': None,\n   'enableAzmlInt': True,\n   'priority': 'Medium',\n   'slaTier': 'Standard',\n   'userAlias': None},\n  'kubernetesCompute': {'instanceType': None},\n  'tensorflow': {'workerCount': 1, 'parameterServerCount': 1},\n  'mpi': {'processCountPerNode': 1},\n  'pyTorch': {'communicationBackend': 'nccl', 'processCount': None},\n  'hdi': {'yarnDeployMode': 'Cluster'},\n  'containerInstance': {'region': None, 'cpuCores': 2.0, 'memoryGb': 3.5},\n  'exposedPorts': None,\n  'docker': {'useDocker': False,\n   'sharedVolumes': True,\n   'shmSize': '2g',\n   'arguments': []},\n  'cmk8sCompute': {'configuration': {}},\n  'commandReturnCodeConfig': {'returnCode': 'Zero',\n   'successfulReturnCodes': []},\n  'environmentVariables': {},\n  'applicationEndpoints': {},\n  'parameters': []},\n 'logFiles': {'azureml-logs/20_image_build_log.txt': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646127808_cca6ccee/azureml-logs/20_image_build_log.txt?sv=2019-07-07&sr=b&sig=czTD1DfDPChOBwn%2FUBn3ai2vEI5onKnLkhjRuQt%2BgxQ%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T08%3A41%3A26Z&ske=2022-03-02T16%3A51%3A26Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A38%3A44Z&se=2022-03-01T17%3A48%3A44Z&sp=r',\n  'azureml-logs/55_azureml-execution-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646127808_cca6ccee/azureml-logs/55_azureml-execution-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt?sv=2019-07-07&sr=b&sig=5cwACgxx7soGR6dhWC4wuN3pv0wK0KjUVQRbYy%2BO680%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T08%3A41%3A26Z&ske=2022-03-02T16%3A51%3A26Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A38%3A44Z&se=2022-03-01T17%3A48%3A44Z&sp=r',\n  'azureml-logs/65_job_prep-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646127808_cca6ccee/azureml-logs/65_job_prep-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt?sv=2019-07-07&sr=b&sig=VkXRGTWUAPOcgSzqcDx6ZW6TKKDWLEz%2Fw%2Fd%2FZe4qzCk%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T08%3A41%3A26Z&ske=2022-03-02T16%3A51%3A26Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A38%3A44Z&se=2022-03-01T17%3A48%3A44Z&sp=r',\n  'azureml-logs/70_driver_log.txt': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646127808_cca6ccee/azureml-logs/70_driver_log.txt?sv=2019-07-07&sr=b&sig=SakJ%2BhdxEwbwV2nvu7ZlpETgxaQC6Atf8UcLSE%2BEYmM%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T08%3A41%3A26Z&ske=2022-03-02T16%3A51%3A26Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A38%3A44Z&se=2022-03-01T17%3A48%3A44Z&sp=r',\n  'azureml-logs/75_job_post-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646127808_cca6ccee/azureml-logs/75_job_post-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt?sv=2019-07-07&sr=b&sig=ZFTb0bKWNkDVptpl4CwayRvl3vE96XqlOi6bdX8%2FhQE%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T08%3A41%3A26Z&ske=2022-03-02T16%3A51%3A26Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A38%3A44Z&se=2022-03-01T17%3A48%3A44Z&sp=r',\n  'azureml-logs/process_info.json': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646127808_cca6ccee/azureml-logs/process_info.json?sv=2019-07-07&sr=b&sig=iHXp5m0qKC1EKYucj79iAJfuD7gHM8ss9N8GvMCvLqM%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T08%3A41%3A26Z&ske=2022-03-02T16%3A51%3A26Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A38%3A44Z&se=2022-03-01T17%3A48%3A44Z&sp=r',\n  'azureml-logs/process_status.json': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646127808_cca6ccee/azureml-logs/process_status.json?sv=2019-07-07&sr=b&sig=LRwueAz3FTnyNxreKmlwGAd7oAZxXY5JI5BrPAAvDyc%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T08%3A41%3A26Z&ske=2022-03-02T16%3A51%3A26Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A38%3A44Z&se=2022-03-01T17%3A48%3A44Z&sp=r',\n  'logs/azureml/98_azureml.log': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646127808_cca6ccee/logs/azureml/98_azureml.log?sv=2019-07-07&sr=b&sig=vuoga3aSp4kV7ZakRnHehBp%2ByfMJHVq8YmWge20616Y%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T09%3A09%3A09Z&ske=2022-03-02T17%3A19%3A09Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A38%3A44Z&se=2022-03-01T17%3A48%3A44Z&sp=r',\n  'logs/azureml/job_prep_azureml.log': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646127808_cca6ccee/logs/azureml/job_prep_azureml.log?sv=2019-07-07&sr=b&sig=46UOcADHsMBJjrfcEJuzZGp4NxZXmb3dz2ANBON0oR0%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T09%3A09%3A09Z&ske=2022-03-02T17%3A19%3A09Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A38%3A44Z&se=2022-03-01T17%3A48%3A44Z&sp=r',\n  'logs/azureml/job_release_azureml.log': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646127808_cca6ccee/logs/azureml/job_release_azureml.log?sv=2019-07-07&sr=b&sig=I6lS7no0erRv%2B%2FN5l07nPEitlkxuR0xsF%2Fs665qRfwg%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T09%3A09%3A09Z&ske=2022-03-02T17%3A19%3A09Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A38%3A44Z&se=2022-03-01T17%3A48%3A44Z&sp=r'},\n 'submittedBy': 'Hyun Suk Shin (MTC SEATTLE)'}"
          },
          "metadata": {}
        }
      ],
      "execution_count": 13,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "> TIP\n",
        "> [Prep your code for production](https://docs.microsoft.com/en-us/azure/machine-learning/tutorial-convert-ml-experiment-to-production)"
      ],
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "## ScriptRunConfig\n",
        "\n",
        "### azureml.core.script_run_config.ScriptRunConfig\n"
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "from azureml.core.experiment import Experiment\n",
        "from azureml.core import ScriptRunConfig\n",
        "\n",
        "runconfig = ScriptRunConfig(\n",
        "    source_directory=\"./source/train\",\n",
        "    script=\"train.py\")\n",
        "\n",
        "# Attach compute target to run config\n",
        "runconfig.run_config.target = \"local\"\n",
        "\n",
        "# Attach environment to run config\n",
        "runconfig.run_config.environment = myenv\n",
        "\n",
        "experiment = Experiment(workspace=ws, name=expName)\n",
        "\n",
        "run = experiment.submit(config=script_run_config)\n",
        "\n",
        "run.wait_for_completion(show_output=True)"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "RunId: mtc-aml-lab-exp_1646128159_f5b2fa8e\nWeb View: https://ml.azure.com/runs/mtc-aml-lab-exp_1646128159_f5b2fa8e?wsid=/subscriptions/89da9f33-fd31-4ece-861e-5fab7af4dc11/resourcegroups/mtcs-dev-aml-rg/workspaces/mtcs-dev-aml&tid=72f988bf-86f1-41af-91ab-2d7cd011db47\n\nStreaming azureml-logs/55_azureml-execution-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt\n========================================================================================================================\n\n2022-03-01T09:49:31Z Running following command: /bin/bash -c sudo blobfuse /mnt/batch/tasks/shared/LS_root/jobs/mtcs-dev-aml/azureml/mtc-aml-lab-exp_1646128159_f5b2fa8e/mounts/workspaceblobstore --tmp-path=/mnt/batch/tasks/shared/LS_root/jobs/mtcs-dev-aml/azureml/mtc-aml-lab-exp_1646128159_f5b2fa8e/caches/workspaceblobstore -o ro --file-cache-timeout-in-seconds=1000000 --cache-size-mb=10741 -o nonempty -o allow_other --config-file=/mnt/batch/tasks/shared/LS_root/jobs/mtcs-dev-aml/azureml/mtc-aml-lab-exp_1646128159_f5b2fa8e/configs/workspaceblobstore.cfg --log-level=LOG_WARNING\n2022-03-01T09:49:31Z Successfully mounted a/an Blobfuse File System at /mnt/batch/tasks/shared/LS_root/jobs/mtcs-dev-aml/azureml/mtc-aml-lab-exp_1646128159_f5b2fa8e/mounts/workspaceblobstore -- stdout/stderr: \n2022-03-01T09:49:31Z The vmsize standard_ds3_v2 is not a GPU VM, skipping get GPU count by running nvidia-smi command.\n2022-03-01T09:49:31Z Starting output-watcher...\n2022-03-01T09:49:31Z IsDedicatedCompute == True, won't poll for Low Pri Preemption\n2022-03-01T09:49:31Z Executing 'Copy ACR Details file' on 10.1.0.5\n2022-03-01T09:49:31Z Copy ACR Details file succeeded on 10.1.0.5. Output: \n>>>   \n>>>   \nLogin Succeeded\n\nStreaming azureml-logs/75_job_post-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt\n===============================================================================================================\n\n[2022-03-01T09:49:41.978247] Entering job release\n[2022-03-01T09:49:43.236935] Starting job release\n[2022-03-01T09:49:43.237703] Logging experiment finalizing status in history service.\nStarting the daemon thread to refresh tokens in background for process with pid = 120\n[2022-03-01T09:49:43.238927] job release stage : upload_datastore starting...\n[2022-03-01T09:49:43.241691] job release stage : start importing azureml.history._tracking in run_history_release.\n[2022-03-01T09:49:43.242165] job release stage : copy_batchai_cached_logs starting...\n[2022-03-01T09:49:43.242246] job release stage : execute_job_release starting...\n[2022-03-01T09:49:43.242681] Entering context manager injector.\n[2022-03-01T09:49:43.242756] job release stage : copy_batchai_cached_logs completed...\n[2022-03-01T09:49:43.254550] job release stage : upload_datastore completed...\n[2022-03-01T09:49:43.351877] job release stage : send_run_telemetry starting...\n[2022-03-01T09:49:43.383394] get vm size and vm region successfully.\n[2022-03-01T09:49:43.392094] get compute meta data successfully.\n[2022-03-01T09:49:43.523878] job release stage : execute_job_release completed...\n[2022-03-01T09:49:43.736447] post artifact meta request successfully.\n[2022-03-01T09:49:43.771872] upload compute record artifact successfully.\n[2022-03-01T09:49:43.771986] job release stage : send_run_telemetry completed...\n[2022-03-01T09:49:43.772231] Job release is complete\n\nExecution Summary\n=================\nRunId: mtc-aml-lab-exp_1646128159_f5b2fa8e\nWeb View: https://ml.azure.com/runs/mtc-aml-lab-exp_1646128159_f5b2fa8e?wsid=/subscriptions/89da9f33-fd31-4ece-861e-5fab7af4dc11/resourcegroups/mtcs-dev-aml-rg/workspaces/mtcs-dev-aml&tid=72f988bf-86f1-41af-91ab-2d7cd011db47\n\n"
        },
        {
          "output_type": "execute_result",
          "execution_count": 14,
          "data": {
            "text/plain": "{'runId': 'mtc-aml-lab-exp_1646128159_f5b2fa8e',\n 'target': 'hyssh1',\n 'status': 'Completed',\n 'startTimeUtc': '2022-03-01T09:49:29.771858Z',\n 'endTimeUtc': '2022-03-01T09:49:52.686096Z',\n 'services': {},\n 'properties': {'_azureml.ComputeTargetType': 'amlcompute',\n  'ContentSnapshotId': '07e79727-d135-4b40-934b-67523cae3ea3',\n  'ProcessInfoFile': 'azureml-logs/process_info.json',\n  'ProcessStatusFile': 'azureml-logs/process_status.json',\n  'azureml.git.repository_uri': 'https://github.com/hyssh/mtc-open-workshop.git',\n  'mlflow.source.git.repoURL': 'https://github.com/hyssh/mtc-open-workshop.git',\n  'azureml.git.branch': 'master',\n  'mlflow.source.git.branch': 'master',\n  'azureml.git.commit': '971b75559670c5ff8880ddd2b70372227a814603',\n  'mlflow.source.git.commit': '971b75559670c5ff8880ddd2b70372227a814603',\n  'azureml.git.dirty': 'True'},\n 'inputDatasets': [],\n 'outputDatasets': [],\n 'runDefinition': {'script': 'train.py',\n  'command': '',\n  'useAbsolutePath': False,\n  'arguments': [],\n  'sourceDirectoryDataStore': None,\n  'framework': 'Python',\n  'communicator': 'None',\n  'target': 'hyssh1',\n  'dataReferences': {},\n  'data': {},\n  'outputData': {},\n  'datacaches': [],\n  'jobName': None,\n  'maxRunDurationSeconds': None,\n  'nodeCount': 1,\n  'instanceTypes': [],\n  'priority': None,\n  'credentialPassthrough': False,\n  'identity': None,\n  'environment': {'name': 'myEnv',\n   'version': '5',\n   'python': {'interpreterPath': 'python',\n    'userManagedDependencies': False,\n    'condaDependencies': {'channels': ['anaconda', 'conda-forge'],\n     'dependencies': ['python=3.6',\n      {'pip': ['azureml-defaults', 'scikit-learn', 'pillow']},\n      'numpy==1.17.0'],\n     'name': 'azureml_919bc46b07c95161e32444ce80d6d83c'},\n    'baseCondaEnvironment': None},\n   'environmentVariables': {'EXAMPLE_ENV_VAR': 'EXAMPLE_VALUE'},\n   'docker': {'baseImage': 'mcr.microsoft.com/azureml/openmpi3.1.2-ubuntu18.04:20211124.v1',\n    'platform': {'os': 'Linux', 'architecture': 'amd64'},\n    'baseDockerfile': None,\n    'baseImageRegistry': {'address': None, 'username': None, 'password': None},\n    'enabled': False,\n    'arguments': []},\n   'spark': {'repositories': [], 'packages': [], 'precachePackages': True},\n   'inferencingStackVersion': None},\n  'history': {'outputCollection': True,\n   'directoriesToWatch': ['logs'],\n   'enableMLflowTracking': True,\n   'snapshotProject': True},\n  'spark': {'configuration': {'spark.app.name': 'Azure ML Experiment',\n    'spark.yarn.maxAppAttempts': '1'}},\n  'parallelTask': {'maxRetriesPerWorker': 0,\n   'workerCountPerNode': 1,\n   'terminalExitCodes': None,\n   'configuration': {}},\n  'amlCompute': {'name': None,\n   'vmSize': None,\n   'retainCluster': False,\n   'clusterMaxNodeCount': None},\n  'aiSuperComputer': {'instanceType': 'D2',\n   'imageVersion': 'pytorch-1.7.0',\n   'location': None,\n   'aiSuperComputerStorageData': None,\n   'interactive': False,\n   'scalePolicy': None,\n   'virtualClusterArmId': None,\n   'tensorboardLogDirectory': None,\n   'sshPublicKey': None,\n   'sshPublicKeys': None,\n   'enableAzmlInt': True,\n   'priority': 'Medium',\n   'slaTier': 'Standard',\n   'userAlias': None},\n  'kubernetesCompute': {'instanceType': None},\n  'tensorflow': {'workerCount': 1, 'parameterServerCount': 1},\n  'mpi': {'processCountPerNode': 1},\n  'pyTorch': {'communicationBackend': 'nccl', 'processCount': None},\n  'hdi': {'yarnDeployMode': 'Cluster'},\n  'containerInstance': {'region': None, 'cpuCores': 2.0, 'memoryGb': 3.5},\n  'exposedPorts': None,\n  'docker': {'useDocker': False,\n   'sharedVolumes': True,\n   'shmSize': '2g',\n   'arguments': []},\n  'cmk8sCompute': {'configuration': {}},\n  'commandReturnCodeConfig': {'returnCode': 'Zero',\n   'successfulReturnCodes': []},\n  'environmentVariables': {},\n  'applicationEndpoints': {},\n  'parameters': []},\n 'logFiles': {'azureml-logs/55_azureml-execution-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646128159_f5b2fa8e/azureml-logs/55_azureml-execution-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt?sv=2019-07-07&sr=b&sig=lHTyAMy%2FCdlGwg61pWb69Wgxf0pysIpjoOCio%2BPIqf0%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T09%3A09%3A09Z&ske=2022-03-02T17%3A19%3A09Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A39%3A45Z&se=2022-03-01T17%3A49%3A45Z&sp=r',\n  'azureml-logs/65_job_prep-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646128159_f5b2fa8e/azureml-logs/65_job_prep-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt?sv=2019-07-07&sr=b&sig=UBPX1f%2B4Ih%2FYU9dcobokSHuCOPabQOxk6qrXuvr0Fko%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T09%3A09%3A09Z&ske=2022-03-02T17%3A19%3A09Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A39%3A45Z&se=2022-03-01T17%3A49%3A45Z&sp=r',\n  'azureml-logs/70_driver_log.txt': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646128159_f5b2fa8e/azureml-logs/70_driver_log.txt?sv=2019-07-07&sr=b&sig=gTR%2FpKD142b7MJBLDGRKIzdQzYz9hh3ZnKIylAm%2F6mQ%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T09%3A09%3A09Z&ske=2022-03-02T17%3A19%3A09Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A39%3A45Z&se=2022-03-01T17%3A49%3A45Z&sp=r',\n  'azureml-logs/75_job_post-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646128159_f5b2fa8e/azureml-logs/75_job_post-tvmps_c05eed74706cac4f2642307f37d208436dd1b83b3f336d5227dcbcb41e7d4673_d.txt?sv=2019-07-07&sr=b&sig=X32d5hEI9u47Pkxx84uwg42coYsxu57u7CaS4blgaho%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T09%3A09%3A09Z&ske=2022-03-02T17%3A19%3A09Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A39%3A45Z&se=2022-03-01T17%3A49%3A45Z&sp=r',\n  'azureml-logs/process_info.json': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646128159_f5b2fa8e/azureml-logs/process_info.json?sv=2019-07-07&sr=b&sig=0JYgUUL7pX0FGN07sMC24d7QH4d0vYyiHixrpUQ6y9Q%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T09%3A09%3A09Z&ske=2022-03-02T17%3A19%3A09Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A39%3A45Z&se=2022-03-01T17%3A49%3A45Z&sp=r',\n  'azureml-logs/process_status.json': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646128159_f5b2fa8e/azureml-logs/process_status.json?sv=2019-07-07&sr=b&sig=Ct0V44WW0UWEpyJd41rkZl9Q30OiTeVOIleS2txI8CM%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T09%3A09%3A09Z&ske=2022-03-02T17%3A19%3A09Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A39%3A45Z&se=2022-03-01T17%3A49%3A45Z&sp=r',\n  'logs/azureml/95_azureml.log': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646128159_f5b2fa8e/logs/azureml/95_azureml.log?sv=2019-07-07&sr=b&sig=YlR3uZ9bwmo5AkeUyGRtI2YDZTUFK4Q8yC3FNuWIFkI%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T08%3A57%3A24Z&ske=2022-03-02T17%3A07%3A24Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A39%3A45Z&se=2022-03-01T17%3A49%3A45Z&sp=r',\n  'logs/azureml/job_prep_azureml.log': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646128159_f5b2fa8e/logs/azureml/job_prep_azureml.log?sv=2019-07-07&sr=b&sig=%2BhXefFAmNBH0dl%2BUKYI7n9R9V%2B5fX7Udj85TsXObcEY%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T08%3A57%3A24Z&ske=2022-03-02T17%3A07%3A24Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A39%3A45Z&se=2022-03-01T17%3A49%3A45Z&sp=r',\n  'logs/azureml/job_release_azureml.log': 'https://mtcsdevamlsa.blob.core.windows.net/azureml/ExperimentRun/dcid.mtc-aml-lab-exp_1646128159_f5b2fa8e/logs/azureml/job_release_azureml.log?sv=2019-07-07&sr=b&sig=j95kSoMpemnXxyK%2BHTH0piZSCSpVBGoFboyY5HpMPus%3D&skoid=825a800c-aeb0-41be-945e-3caf8d9b5f19&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2022-03-01T08%3A57%3A24Z&ske=2022-03-02T17%3A07%3A24Z&sks=b&skv=2019-07-07&st=2022-03-01T09%3A39%3A45Z&se=2022-03-01T17%3A49%3A45Z&sp=r'},\n 'submittedBy': 'Hyun Suk Shin (MTC SEATTLE)'}"
          },
          "metadata": {}
        }
      ],
      "execution_count": 14,
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Pipeline, PythonScriptStep\n",
        "\n",
        "### azureml.pipeline.core.pipeline.Pipeline\n",
        "### azureml.pipeline.steps.python_script_step.PythonScriptStep\n",
        "\n",
        "\n",
        "An Azure Machine Learning pipeline is an automated workflow of a complete machine learning task. Subtasks are encapsulated as a series of steps within the pipeline. An Azure Machine Learning pipeline can be as simple as one step that calls a Python script. Pipelines include functionality for:\n",
        "\n",
        "- Data preparation including importing, validating and cleaning, munging and transformation, normalization, and staging\n",
        "- Training configuration including parameterizing arguments, filepaths, and logging / reporting configurations\n",
        "- Training and validating efficiently and repeatably, which might include specifying specific data subsets, different hardware compute resources, distributed processing, and progress monitoring\n",
        "- Deployment, including versioning, scaling, provisioning, and access control\n",
        "- Publishing a pipeline to a REST endpoint to rerun from any HTTP library\n",
        "\n",
        "A ```PythonScriptStep``` is a basic, built-in step to run a Python Script on a compute target. It takes a script name and other optional parameters like arguments for the script, compute target, inputs and outputs. "
      ],
      "metadata": {}
    },
    {
      "cell_type": "markdown",
      "source": [
        "### Pattern for creating and using ML Pipeline\n",
        "\n",
        "An Azure Machine Learning pipeline is associated with an Azure Machine Learning workspace and a pipeline step is associated with a compute target available within that workspace. For more information, see this article about workspaces or this explanation of compute targets.\n",
        "\n",
        "A common pattern for pipeline steps is:\n",
        "\n",
        "1. Specify workspace, compute, and storage\n",
        "2. Configure your input and output data using\n",
        "    1. Dataset which makes available an existing Azure datastore\n",
        "    2. PipelineDataset which encapsulates typed tabular data\n",
        "    3. PipelineData which is used for intermediate file or directory data written by one step and intended to be consumed by another\n",
        "3. Define one or more pipeline steps\n",
        "4. Instantiate a pipeline using your workspace and steps\n",
        "5. Create an experiment to which you submit the pipeline\n",
        "6. Monitor the experiment results"
      ],
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "from azureml.core import Dataset\n",
        "from azureml.pipeline.steps import PythonScriptStep\n",
        "from azureml.pipeline.core import Pipeline, PipelineData\n",
        "\n",
        "# get input dataset\n",
        "input_ds = Dataset.get_by_name(workspace, 'weather_ds')\n",
        "\n",
        "# register pipeline output as dataset\n",
        "output_ds = PipelineData('prepared_weather_ds', datastore=datastore).as_dataset()\n",
        "output_ds = output_ds.register(name='prepared_weather_ds', create_new_version=True)\n",
        "\n",
        "# configure pipeline step to use dataset as the input and output\n",
        "prep_step = PythonScriptStep(script_name=\"prepare.py\",\n",
        "                             inputs=[input_ds.as_named_input('weather_ds')],\n",
        "                             outputs=[output_ds],\n",
        "                             compute_target=compute_target,\n",
        "                             source_directory=project_folder)\n",
        "\n",
        "\n",
        "# Python Script Step\n",
        "from azureml.pipeline.steps import PythonScriptStep\n",
        "\n",
        "train_step = PythonScriptStep(\n",
        "    script_name=\"train.py\",\n",
        "    arguments=[\"--input\", blob_input_data, \"--output\", output_data1],\n",
        "    inputs=[blob_input_data],\n",
        "    outputs=[output_data1],\n",
        "    compute_target=compute_target,\n",
        "    source_directory=project_folder\n",
        ")"
      ],
      "outputs": [],
      "execution_count": null,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "from azureml.pipeline.core import Pipeline\n",
        "\n",
        "pipeline = Pipeline(workspace=ws, steps=[train_step])\n",
        "# pipeline_run = experiment.submit(pipeline)"
      ],
      "outputs": [],
      "execution_count": null,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [
        "#End of notebook"
      ],
      "outputs": [],
      "execution_count": null,
      "metadata": {}
    },
    {
      "cell_type": "code",
      "source": [],
      "outputs": [],
      "execution_count": null,
      "metadata": {}
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "python38-azureml",
      "language": "python",
      "display_name": "Python 3.8 - AzureML"
    },
    "language_info": {
      "name": "python",
      "version": "3.8.1",
      "mimetype": "text/x-python",
      "codemirror_mode": {
        "name": "ipython",
        "version": 3
      },
      "pygments_lexer": "ipython3",
      "nbconvert_exporter": "python",
      "file_extension": ".py"
    },
    "kernel_info": {
      "name": "python38-azureml"
    },
    "nteract": {
      "version": "nteract-front-end@1.0.0"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 0
}